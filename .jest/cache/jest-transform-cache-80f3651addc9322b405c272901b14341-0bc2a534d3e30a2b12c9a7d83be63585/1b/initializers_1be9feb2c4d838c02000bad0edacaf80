488538a1ecf89796d4c0301f26da9c78
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.initializeUIRuntime = initializeUIRuntime;
var _errors = require("./errors");
var _NativeReanimated = _interopRequireDefault(require("./NativeReanimated"));
var _PlatformChecker = require("./PlatformChecker");
var _threads = require("./threads");
function callGuardDEV(fn) {
  'worklet';

  for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    args[_key - 1] = arguments[_key];
  }
  try {
    fn.apply(void 0, args);
  } catch (e) {
    if (global.__ErrorUtils) {
      global.__ErrorUtils.reportFatalError(e);
    } else {
      throw e;
    }
  }
}
function valueUnpacker(objectToUnpack, category) {
  'worklet';

  var workletsCache = global.__workletsCache;
  var handleCache = global.__handleCache;
  if (workletsCache === undefined) {
    workletsCache = global.__workletsCache = new Map();
    handleCache = global.__handleCache = new WeakMap();
  }
  var workletHash = objectToUnpack.__workletHash;
  if (workletHash !== undefined) {
    var workletFun = workletsCache.get(workletHash);
    if (workletFun === undefined) {
      var initData = objectToUnpack.__initData;
      if (global.evalWithSourceMap) {
        workletFun = global.evalWithSourceMap('(' + initData.code + '\n)', initData.location, initData.sourceMap);
      } else if (global.evalWithSourceUrl) {
        workletFun = global.evalWithSourceUrl('(' + initData.code + '\n)', `worklet_${workletHash}`);
      } else {
        workletFun = eval('(' + initData.code + '\n)');
      }
      workletsCache.set(workletHash, workletFun);
    }
    var functionInstance = workletFun.bind(objectToUnpack);
    objectToUnpack._recur = functionInstance;
    return functionInstance;
  } else if (objectToUnpack.__init) {
    var value = handleCache.get(objectToUnpack);
    if (value === undefined) {
      value = objectToUnpack.__init();
      handleCache.set(objectToUnpack, value);
    }
    return value;
  } else if (category === 'RemoteFunction') {
    var fun = function fun() {
      throw new Error(`Tried to synchronously call a non-worklet function on the UI thread.

Possible solutions are:
  a) If you want to synchronously execute this method, mark it as a worklet
  b) If you want to execute this function on the JS thread, wrap it using \`runOnJS\``);
    };
    fun.__remoteFunction = objectToUnpack;
    return fun;
  } else {
    throw new Error('data type not recognized by unpack method');
  }
}
function setupRequestAnimationFrame() {
  'worklet';
  var nativeRequestAnimationFrame = global.requestAnimationFrame;
  var animationFrameCallbacks = [];
  var lastNativeAnimationFrameTimestamp = -1;
  global.__flushAnimationFrame = function (frameTimestamp) {
    var currentCallbacks = animationFrameCallbacks;
    animationFrameCallbacks = [];
    currentCallbacks.forEach(function (f) {
      return f(frameTimestamp);
    });
    (0, _threads.callMicrotasks)();
  };
  global.requestAnimationFrame = function (callback) {
    animationFrameCallbacks.push(callback);
    if (animationFrameCallbacks.length === 1) {
      nativeRequestAnimationFrame(function (timestamp) {
        if (lastNativeAnimationFrameTimestamp >= timestamp) {
          return;
        }
        lastNativeAnimationFrameTimestamp = timestamp;
        global.__frameTimestamp = timestamp;
        global.__flushAnimationFrame(timestamp);
        global.__frameTimestamp = undefined;
      });
    }
    return -1;
  };
}
function initializeUIRuntime() {
  _NativeReanimated.default.installCoreFunctions(callGuardDEV, valueUnpacker);
  var IS_JEST = (0, _PlatformChecker.isJest)();
  var IS_CHROME_DEBUGGER = (0, _PlatformChecker.isChromeDebugger)();
  var IS_NATIVE = !(0, _PlatformChecker.shouldBeUseWeb)();
  if (IS_JEST) {
    global.requestAnimationFrame = function (callback) {
      return setTimeout(function () {
        return callback(performance.now());
      }, 0);
    };
  }
  var capturableConsole = Object.assign({}, console);
  (0, _threads.runOnUIImmediately)(function () {
    'worklet';
    global.__ErrorUtils = {
      reportFatalError: function reportFatalError(error) {
        (0, _threads.runOnJS)(_errors.reportFatalErrorOnJS)({
          message: error.message,
          stack: error.stack
        });
      }
    };
    if (!IS_CHROME_DEBUGGER) {
      global.console = {
        assert: (0, _threads.runOnJS)(capturableConsole.assert),
        debug: (0, _threads.runOnJS)(capturableConsole.debug),
        log: (0, _threads.runOnJS)(capturableConsole.log),
        warn: (0, _threads.runOnJS)(capturableConsole.warn),
        error: (0, _threads.runOnJS)(capturableConsole.error),
        info: (0, _threads.runOnJS)(capturableConsole.info)
      };
    }
    if (IS_NATIVE) {
      (0, _threads.setupMicrotasks)();
      setupRequestAnimationFrame();
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZXJyb3JzIiwicmVxdWlyZSIsIl9OYXRpdmVSZWFuaW1hdGVkIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9QbGF0Zm9ybUNoZWNrZXIiLCJfdGhyZWFkcyIsImNhbGxHdWFyZERFViIsImZuIiwiX2xlbiIsImFyZ3VtZW50cyIsImxlbmd0aCIsImFyZ3MiLCJBcnJheSIsIl9rZXkiLCJhcHBseSIsImUiLCJnbG9iYWwiLCJfX0Vycm9yVXRpbHMiLCJyZXBvcnRGYXRhbEVycm9yIiwidmFsdWVVbnBhY2tlciIsIm9iamVjdFRvVW5wYWNrIiwiY2F0ZWdvcnkiLCJ3b3JrbGV0c0NhY2hlIiwiX193b3JrbGV0c0NhY2hlIiwiaGFuZGxlQ2FjaGUiLCJfX2hhbmRsZUNhY2hlIiwidW5kZWZpbmVkIiwiTWFwIiwiV2Vha01hcCIsIndvcmtsZXRIYXNoIiwiX193b3JrbGV0SGFzaCIsIndvcmtsZXRGdW4iLCJnZXQiLCJpbml0RGF0YSIsIl9faW5pdERhdGEiLCJldmFsV2l0aFNvdXJjZU1hcCIsImNvZGUiLCJsb2NhdGlvbiIsInNvdXJjZU1hcCIsImV2YWxXaXRoU291cmNlVXJsIiwiZXZhbCIsInNldCIsImZ1bmN0aW9uSW5zdGFuY2UiLCJiaW5kIiwiX3JlY3VyIiwiX19pbml0IiwidmFsdWUiLCJmdW4iLCJFcnJvciIsIl9fcmVtb3RlRnVuY3Rpb24iLCJzZXR1cFJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm5hdGl2ZVJlcXVlc3RBbmltYXRpb25GcmFtZSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImFuaW1hdGlvbkZyYW1lQ2FsbGJhY2tzIiwibGFzdE5hdGl2ZUFuaW1hdGlvbkZyYW1lVGltZXN0YW1wIiwiX19mbHVzaEFuaW1hdGlvbkZyYW1lIiwiZnJhbWVUaW1lc3RhbXAiLCJjdXJyZW50Q2FsbGJhY2tzIiwiZm9yRWFjaCIsImYiLCJjYWxsTWljcm90YXNrcyIsImNhbGxiYWNrIiwicHVzaCIsInRpbWVzdGFtcCIsIl9fZnJhbWVUaW1lc3RhbXAiLCJpbml0aWFsaXplVUlSdW50aW1lIiwiTmF0aXZlUmVhbmltYXRlZE1vZHVsZSIsImluc3RhbGxDb3JlRnVuY3Rpb25zIiwiSVNfSkVTVCIsImlzSmVzdCIsIklTX0NIUk9NRV9ERUJVR0dFUiIsImlzQ2hyb21lRGVidWdnZXIiLCJJU19OQVRJVkUiLCJzaG91bGRCZVVzZVdlYiIsInNldFRpbWVvdXQiLCJwZXJmb3JtYW5jZSIsIm5vdyIsImNhcHR1cmFibGVDb25zb2xlIiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsInJ1bk9uVUlJbW1lZGlhdGVseSIsImVycm9yIiwicnVuT25KUyIsInJlcG9ydEZhdGFsRXJyb3JPbkpTIiwibWVzc2FnZSIsInN0YWNrIiwiYXNzZXJ0IiwiZGVidWciLCJsb2ciLCJ3YXJuIiwiaW5mbyIsInNldHVwTWljcm90YXNrcyJdLCJzb3VyY2VzIjpbImluaXRpYWxpemVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXBvcnRGYXRhbEVycm9yT25KUyB9IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCBOYXRpdmVSZWFuaW1hdGVkTW9kdWxlIGZyb20gJy4vTmF0aXZlUmVhbmltYXRlZCc7XG5pbXBvcnQgeyBpc0Nocm9tZURlYnVnZ2VyLCBpc0plc3QsIHNob3VsZEJlVXNlV2ViIH0gZnJvbSAnLi9QbGF0Zm9ybUNoZWNrZXInO1xuaW1wb3J0IHtcbiAgcnVuT25KUyxcbiAgc2V0dXBNaWNyb3Rhc2tzLFxuICBjYWxsTWljcm90YXNrcyxcbiAgcnVuT25VSUltbWVkaWF0ZWx5LFxufSBmcm9tICcuL3RocmVhZHMnO1xuXG4vLyBjYWxsR3VhcmQgaXMgb25seSB1c2VkIHdpdGggZGVidWcgYnVpbGRzXG5mdW5jdGlvbiBjYWxsR3VhcmRERVY8VCBleHRlbmRzIEFycmF5PHVua25vd24+LCBVPihcbiAgZm46ICguLi5hcmdzOiBUKSA9PiBVLFxuICAuLi5hcmdzOiBUXG4pOiB2b2lkIHtcbiAgJ3dvcmtsZXQnO1xuICB0cnkge1xuICAgIGZuKC4uLmFyZ3MpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGdsb2JhbC5fX0Vycm9yVXRpbHMpIHtcbiAgICAgIGdsb2JhbC5fX0Vycm9yVXRpbHMucmVwb3J0RmF0YWxFcnJvcihlIGFzIEVycm9yKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmFsdWVVbnBhY2tlcihvYmplY3RUb1VucGFjazogYW55LCBjYXRlZ29yeT86IHN0cmluZyk6IGFueSB7XG4gICd3b3JrbGV0JztcbiAgbGV0IHdvcmtsZXRzQ2FjaGUgPSBnbG9iYWwuX193b3JrbGV0c0NhY2hlO1xuICBsZXQgaGFuZGxlQ2FjaGUgPSBnbG9iYWwuX19oYW5kbGVDYWNoZTtcbiAgaWYgKHdvcmtsZXRzQ2FjaGUgPT09IHVuZGVmaW5lZCkge1xuICAgIC8vIGluaXRcbiAgICB3b3JrbGV0c0NhY2hlID0gZ2xvYmFsLl9fd29ya2xldHNDYWNoZSA9IG5ldyBNYXAoKTtcbiAgICBoYW5kbGVDYWNoZSA9IGdsb2JhbC5fX2hhbmRsZUNhY2hlID0gbmV3IFdlYWtNYXAoKTtcbiAgfVxuICBjb25zdCB3b3JrbGV0SGFzaCA9IG9iamVjdFRvVW5wYWNrLl9fd29ya2xldEhhc2g7XG4gIGlmICh3b3JrbGV0SGFzaCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IHdvcmtsZXRGdW4gPSB3b3JrbGV0c0NhY2hlLmdldCh3b3JrbGV0SGFzaCk7XG4gICAgaWYgKHdvcmtsZXRGdW4gPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc3QgaW5pdERhdGEgPSBvYmplY3RUb1VucGFjay5fX2luaXREYXRhO1xuICAgICAgaWYgKGdsb2JhbC5ldmFsV2l0aFNvdXJjZU1hcCkge1xuICAgICAgICAvLyBpZiB0aGUgcnVudGltZSAoaGVybWVzIG9ubHkgZm9yIG5vdykgc3VwcG9ydHMgbG9hZGluZyBzb3VyY2UgbWFwc1xuICAgICAgICAvLyB3ZSB3YW50IHRvIHVzZSB0aGUgcHJvcGVyIGZpbGVuYW1lIGZvciB0aGUgbG9jYXRpb24gYXMgaXQgZ3VhcmFudGVlc1xuICAgICAgICAvLyB0aGF0IGRlYnVnZ2VyIHVuZGVyc3RhbmRzIGFuZCBsb2FkcyB0aGUgc291cmNlIGNvZGUgb2YgdGhlIGZpbGUgd2hlcmVcbiAgICAgICAgLy8gdGhlIHdvcmtsZXQgaXMgZGVmaW5lZC5cbiAgICAgICAgd29ya2xldEZ1biA9IGdsb2JhbC5ldmFsV2l0aFNvdXJjZU1hcChcbiAgICAgICAgICAnKCcgKyBpbml0RGF0YS5jb2RlICsgJ1xcbiknLFxuICAgICAgICAgIGluaXREYXRhLmxvY2F0aW9uLFxuICAgICAgICAgIGluaXREYXRhLnNvdXJjZU1hcFxuICAgICAgICApIGFzICguLi5hcmdzOiBhbnlbXSkgPT4gYW55O1xuICAgICAgfSBlbHNlIGlmIChnbG9iYWwuZXZhbFdpdGhTb3VyY2VVcmwpIHtcbiAgICAgICAgLy8gaWYgdGhlIHJ1bnRpbWUgZG9lc24ndCBzdXBwb3J0IGxvYWRpbmcgc291cmNlIG1hcHMsIGluIGRldiBtb2RlIHdlXG4gICAgICAgIC8vIGNhbiBwYXNzIHNvdXJjZSB1cmwgd2hlbiBldmFsdWF0aW5nIHRoZSB3b3JrbGV0LiBOb3csIGluc3RlYWQgb2YgdXNpbmdcbiAgICAgICAgLy8gdGhlIGFjdHVhbCBmaWxlIGxvY2F0aW9uIHdlIHVzZSB3b3JrbGV0IGhhc2gsIGFzIGl0IHRoZSBhbGxvd3MgdXMgdG9cbiAgICAgICAgLy8gcHJvcGVybHkgc3ltYm9saWNhdGUgdHJhY2VzIChzZWUgZXJyb3JzLnRzIGZvciBkZXRhaWxzKVxuICAgICAgICB3b3JrbGV0RnVuID0gZ2xvYmFsLmV2YWxXaXRoU291cmNlVXJsKFxuICAgICAgICAgICcoJyArIGluaXREYXRhLmNvZGUgKyAnXFxuKScsXG4gICAgICAgICAgYHdvcmtsZXRfJHt3b3JrbGV0SGFzaH1gXG4gICAgICAgICkgYXMgKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpbiByZWxlYXNlIHdlIHVzZSB0aGUgcmVndWxhciBldmFsIHRvIHNhdmUgb24gSlNJIGNhbGxzXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1ldmFsXG4gICAgICAgIHdvcmtsZXRGdW4gPSBldmFsKCcoJyArIGluaXREYXRhLmNvZGUgKyAnXFxuKScpIGFzIChcbiAgICAgICAgICAuLi5hcmdzOiBhbnlbXVxuICAgICAgICApID0+IGFueTtcbiAgICAgIH1cbiAgICAgIHdvcmtsZXRzQ2FjaGUuc2V0KHdvcmtsZXRIYXNoLCB3b3JrbGV0RnVuKTtcbiAgICB9XG4gICAgY29uc3QgZnVuY3Rpb25JbnN0YW5jZSA9IHdvcmtsZXRGdW4uYmluZChvYmplY3RUb1VucGFjayk7XG4gICAgb2JqZWN0VG9VbnBhY2suX3JlY3VyID0gZnVuY3Rpb25JbnN0YW5jZTtcbiAgICByZXR1cm4gZnVuY3Rpb25JbnN0YW5jZTtcbiAgfSBlbHNlIGlmIChvYmplY3RUb1VucGFjay5fX2luaXQpIHtcbiAgICBsZXQgdmFsdWUgPSBoYW5kbGVDYWNoZSEuZ2V0KG9iamVjdFRvVW5wYWNrKTtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBvYmplY3RUb1VucGFjay5fX2luaXQoKTtcbiAgICAgIGhhbmRsZUNhY2hlIS5zZXQob2JqZWN0VG9VbnBhY2ssIHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9IGVsc2UgaWYgKGNhdGVnb3J5ID09PSAnUmVtb3RlRnVuY3Rpb24nKSB7XG4gICAgY29uc3QgZnVuID0gKCkgPT4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmllZCB0byBzeW5jaHJvbm91c2x5IGNhbGwgYSBub24td29ya2xldCBmdW5jdGlvbiBvbiB0aGUgVUkgdGhyZWFkLlxuXG5Qb3NzaWJsZSBzb2x1dGlvbnMgYXJlOlxuICBhKSBJZiB5b3Ugd2FudCB0byBzeW5jaHJvbm91c2x5IGV4ZWN1dGUgdGhpcyBtZXRob2QsIG1hcmsgaXQgYXMgYSB3b3JrbGV0XG4gIGIpIElmIHlvdSB3YW50IHRvIGV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBvbiB0aGUgSlMgdGhyZWFkLCB3cmFwIGl0IHVzaW5nIFxcYHJ1bk9uSlNcXGBgKTtcbiAgICB9O1xuICAgIGZ1bi5fX3JlbW90ZUZ1bmN0aW9uID0gb2JqZWN0VG9VbnBhY2s7XG4gICAgcmV0dXJuIGZ1bjtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2RhdGEgdHlwZSBub3QgcmVjb2duaXplZCBieSB1bnBhY2sgbWV0aG9kJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0dXBSZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKSB7XG4gICd3b3JrbGV0JztcblxuICAvLyBKZXN0IG1vY2tzIHJlcXVlc3RBbmltYXRpb25GcmFtZSBBUEkgYW5kIGl0IGRvZXMgbm90IGxpa2UgaWYgdGhhdCBtb2NrIGdldHMgb3ZlcnJpZGRlblxuICAvLyBzbyB3ZSBhdm9pZCBkb2luZyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgYmF0Y2hpbmcgaW4gSmVzdCBlbnZpcm9ubWVudC5cbiAgY29uc3QgbmF0aXZlUmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZTtcblxuICBsZXQgYW5pbWF0aW9uRnJhbWVDYWxsYmFja3M6IEFycmF5PCh0aW1lc3RhbXA6IG51bWJlcikgPT4gdm9pZD4gPSBbXTtcbiAgbGV0IGxhc3ROYXRpdmVBbmltYXRpb25GcmFtZVRpbWVzdGFtcCA9IC0xO1xuXG4gIGdsb2JhbC5fX2ZsdXNoQW5pbWF0aW9uRnJhbWUgPSAoZnJhbWVUaW1lc3RhbXA6IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IGN1cnJlbnRDYWxsYmFja3MgPSBhbmltYXRpb25GcmFtZUNhbGxiYWNrcztcbiAgICBhbmltYXRpb25GcmFtZUNhbGxiYWNrcyA9IFtdO1xuICAgIGN1cnJlbnRDYWxsYmFja3MuZm9yRWFjaCgoZikgPT4gZihmcmFtZVRpbWVzdGFtcCkpO1xuICAgIGNhbGxNaWNyb3Rhc2tzKCk7XG4gIH07XG5cbiAgZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChcbiAgICBjYWxsYmFjazogKHRpbWVzdGFtcDogbnVtYmVyKSA9PiB2b2lkXG4gICk6IG51bWJlciA9PiB7XG4gICAgYW5pbWF0aW9uRnJhbWVDYWxsYmFja3MucHVzaChjYWxsYmFjayk7XG4gICAgaWYgKGFuaW1hdGlvbkZyYW1lQ2FsbGJhY2tzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgLy8gV2Ugc2NoZWR1bGUgbmF0aXZlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBvbmx5IHdoZW4gdGhlIGZpcnN0IGNhbGxiYWNrXG4gICAgICAvLyBpcyBhZGRlZCBhbmQgdGhlbiB1c2UgaXQgdG8gZXhlY3V0ZSBhbGwgdGhlIGVucXVldWVkIGNhbGxiYWNrcy4gT25jZVxuICAgICAgLy8gdGhlIGNhbGxiYWNrcyBhcmUgcnVuLCB3ZSBjbGVhciB0aGUgYXJyYXkuXG4gICAgICBuYXRpdmVSZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKHRpbWVzdGFtcCkgPT4ge1xuICAgICAgICBpZiAobGFzdE5hdGl2ZUFuaW1hdGlvbkZyYW1lVGltZXN0YW1wID49IHRpbWVzdGFtcCkge1xuICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBvbmx5IGV4ZWN1dGUgdGhlIGNhbGxiYWNrcyBvbmNlIGZvciBhIGdpdmVuIGZyYW1lXG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxhc3ROYXRpdmVBbmltYXRpb25GcmFtZVRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICAgICAgZ2xvYmFsLl9fZnJhbWVUaW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgICAgIGdsb2JhbC5fX2ZsdXNoQW5pbWF0aW9uRnJhbWUodGltZXN0YW1wKTtcbiAgICAgICAgZ2xvYmFsLl9fZnJhbWVUaW1lc3RhbXAgPSB1bmRlZmluZWQ7XG4gICAgICB9KTtcbiAgICB9XG4gICAgLy8gUmVhbmltYXRlZCBjdXJyZW50bHkgZG9lcyBub3Qgc3VwcG9ydCBjYW5jZWxsaW5nIGNhbGxiYWNrcyByZXF1ZXN0ZWQgd2l0aFxuICAgIC8vIHJlcXVlc3RBbmltYXRpb25GcmFtZS4gV2UgcmV0dXJuIC0xIGFzIGlkZW50aWZpZXIgd2hpY2ggaXNuJ3QgaW4gbGluZVxuICAgIC8vIHdpdGggdGhlIHNwZWMgYnV0IGl0IHNob3VsZCBnaXZlIHVzZXJzIGJldHRlciBjbHVlIGluIGNhc2UgdGhleSBhY3R1YWxseVxuICAgIC8vIGF0dGVtcHQgdG8gc3RvcmUgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gckFGIGFuZCB1c2UgaXQgZm9yIGNhbmNlbGxpbmcuXG4gICAgcmV0dXJuIC0xO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZVVJUnVudGltZSgpIHtcbiAgTmF0aXZlUmVhbmltYXRlZE1vZHVsZS5pbnN0YWxsQ29yZUZ1bmN0aW9ucyhjYWxsR3VhcmRERVYsIHZhbHVlVW5wYWNrZXIpO1xuXG4gIGNvbnN0IElTX0pFU1QgPSBpc0plc3QoKTtcbiAgY29uc3QgSVNfQ0hST01FX0RFQlVHR0VSID0gaXNDaHJvbWVEZWJ1Z2dlcigpO1xuICBjb25zdCBJU19OQVRJVkUgPSAhc2hvdWxkQmVVc2VXZWIoKTtcblxuICBpZiAoSVNfSkVTVCkge1xuICAgIC8vIHJlcXVlc3RBbmltYXRpb25GcmFtZSByZWFjdC1uYXRpdmUgamVzdCdzIHNldHVwIGlzIGluY29ycmVjdCBhcyBpdCBwb2x5ZmlsbHNcbiAgICAvLyB0aGUgbWV0aG9kIGRpcmVjdGx5IHVzaW5nIHNldFRpbWVvdXQsIHRoZXJlZm9yZSB0aGUgY2FsbGJhY2sgZG9lc24ndCBnZXQgdGhlXG4gICAgLy8gZXhwZWN0ZWQgdGltZXN0YW1wIGFzIHRoZSBvbmx5IGFyZ3VtZW50OiBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QtbmF0aXZlL2Jsb2IvbWFpbi9qZXN0L3NldHVwLmpzI0wyOFxuICAgIC8vIFdlIG92ZXJyaWRlIHRoaXMgc2V0dXAgaGVyZSB0byBtYWtlIHN1cmUgdGhhdCBjYWxsYmFja3MgZ2V0IHRoZSBwcm9wZXIgdGltZXN0YW1wc1xuICAgIC8vIHdoZW4gZXhlY3V0ZWQuIEZvciBub24tamVzdCBlbnZpcm9ubWVudHMgd2UgZGVmaW5lIHJlcXVlc3RBbmltYXRpb25GcmFtZSBpbiBzZXR1cFJlcXVlc3RBbmltYXRpb25GcmFtZVxuICAgIC8vIEB0cy1pZ25vcmUgVHlwZVNjcmlwdCB1c2VzIE5vZGUgZGVmaW5pdGlvbiBmb3IgckFGLCBzZXRUaW1lb3V0LCBldGMgd2hpY2ggcmV0dXJucyBhIFRpbWVvdXQgb2JqZWN0IHJhdGhlciB0aGFuIGEgbnVtYmVyXG4gICAgZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChjYWxsYmFjazogKHRpbWVzdGFtcDogbnVtYmVyKSA9PiB2b2lkKSA9PiB7XG4gICAgICByZXR1cm4gc2V0VGltZW91dCgoKSA9PiBjYWxsYmFjayhwZXJmb3JtYW5jZS5ub3coKSksIDApO1xuICAgIH07XG4gIH1cblxuICAvLyBXZSByZWFsbHkgaGF2ZSB0byBjcmVhdGUgYSBjb3B5IG9mIGNvbnNvbGUgaGVyZS4gRnVuY3Rpb24gcnVuT25KUyB3ZSB1c2Ugb24gZWxlbWVudHMgaW5zaWRlXG4gIC8vIHRoaXMgb2JqZWN0IG1ha2VzIGl0IG5vdCBjb25maWd1cmFibGVcbiAgY29uc3QgY2FwdHVyYWJsZUNvbnNvbGUgPSB7IC4uLmNvbnNvbGUgfTtcbiAgcnVuT25VSUltbWVkaWF0ZWx5KCgpID0+IHtcbiAgICAnd29ya2xldCc7XG4gICAgLy8gc2V0dXAgZXJyb3IgaGFuZGxlclxuICAgIGdsb2JhbC5fX0Vycm9yVXRpbHMgPSB7XG4gICAgICByZXBvcnRGYXRhbEVycm9yOiAoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgIHJ1bk9uSlMocmVwb3J0RmF0YWxFcnJvck9uSlMpKHtcbiAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBpZiAoIUlTX0NIUk9NRV9ERUJVR0dFUikge1xuICAgICAgLy8gc2V0dXAgY29uc29sZVxuICAgICAgLy8gQHRzLWlnbm9yZSBUeXBlU2NyaXB0IGRvZXNuJ3QgbGlrZSB0aGF0IHRoZXJlIGFyZSBtaXNzaW5nIG1ldGhvZHMgaW4gY29uc29sZSBvYmplY3QsIGJ1dCB3ZSBkb24ndCBwcm92aWRlIGFsbCB0aGUgbWV0aG9kcyBmb3IgdGhlIFVJIHJ1bnRpbWUgY29uc29sZSB2ZXJzaW9uXG4gICAgICBnbG9iYWwuY29uc29sZSA9IHtcbiAgICAgICAgYXNzZXJ0OiBydW5PbkpTKGNhcHR1cmFibGVDb25zb2xlLmFzc2VydCksXG4gICAgICAgIGRlYnVnOiBydW5PbkpTKGNhcHR1cmFibGVDb25zb2xlLmRlYnVnKSxcbiAgICAgICAgbG9nOiBydW5PbkpTKGNhcHR1cmFibGVDb25zb2xlLmxvZyksXG4gICAgICAgIHdhcm46IHJ1bk9uSlMoY2FwdHVyYWJsZUNvbnNvbGUud2FybiksXG4gICAgICAgIGVycm9yOiBydW5PbkpTKGNhcHR1cmFibGVDb25zb2xlLmVycm9yKSxcbiAgICAgICAgaW5mbzogcnVuT25KUyhjYXB0dXJhYmxlQ29uc29sZS5pbmZvKSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKElTX05BVElWRSkge1xuICAgICAgc2V0dXBNaWNyb3Rhc2tzKCk7XG4gICAgICBzZXR1cFJlcXVlc3RBbmltYXRpb25GcmFtZSgpO1xuICAgIH1cbiAgfSkoKTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFBQSxPQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxpQkFBQSxHQUFBQyxzQkFBQSxDQUFBRixPQUFBO0FBQ0EsSUFBQUcsZ0JBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLFFBQUEsR0FBQUosT0FBQTtBQVFBLFNBQVNLLFlBQVlBLENBQ25CQyxFQUFxQixFQUVmO0VBQ04sU0FBUzs7RUFBQyxTQUFBQyxJQUFBLEdBQUFD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