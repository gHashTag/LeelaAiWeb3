5ab6818bbf7cbc21e37a425cf5021c50
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createMapperRegistry = createMapperRegistry;
exports.startMapper = startMapper;
exports.stopMapper = stopMapper;
var _PlatformChecker = require("./PlatformChecker");
var _threads = require("./threads");
var _utils = require("./utils");
var IS_JEST = (0, _PlatformChecker.isJest)();
function createMapperRegistry() {
  'worklet';

  var mappers = new Map();
  var sortedMappers = [];
  var runRequested = false;
  var processingMappers = false;
  function updateMappersOrder() {
    var pre = new Map();
    mappers.forEach(function (mapper) {
      if (mapper.outputs) {
        for (var output of mapper.outputs) {
          var preMappers = pre.get(output);
          if (preMappers === undefined) {
            pre.set(output, [mapper]);
          } else {
            preMappers.push(mapper);
          }
        }
      }
    });
    var visited = new Set();
    var newOrder = [];
    function dfs(mapper) {
      visited.add(mapper);
      for (var input of mapper.inputs) {
        var preMappers = pre.get(input);
        if (preMappers) {
          for (var preMapper of preMappers) {
            if (!visited.has(preMapper)) {
              dfs(preMapper);
            }
          }
        }
      }
      newOrder.push(mapper);
    }
    mappers.forEach(function (mapper) {
      if (!visited.has(mapper)) {
        dfs(mapper);
      }
    });
    sortedMappers = newOrder;
  }
  function mapperRun() {
    runRequested = false;
    if (processingMappers) {
      return;
    }
    processingMappers = true;
    if (mappers.size !== sortedMappers.length) {
      updateMappersOrder();
    }
    for (var mapper of sortedMappers) {
      if (mapper.dirty) {
        mapper.dirty = false;
        mapper.worklet();
      }
    }
    processingMappers = false;
  }
  function maybeRequestUpdates() {
    if (IS_JEST) {
      mapperRun();
    } else if (!runRequested) {
      if (processingMappers) {
        requestAnimationFrame(mapperRun);
      } else {
        queueMicrotask(mapperRun);
      }
      runRequested = true;
    }
  }
  function extractInputs(inputs, resultArray) {
    if (Array.isArray(inputs)) {
      for (var input of inputs) {
        input && extractInputs(input, resultArray);
      }
    } else if ((0, _utils.isSharedValue)(inputs)) {
      resultArray.push(inputs);
    } else if (Object.getPrototypeOf(inputs) === Object.prototype) {
      for (var element of Object.values(inputs)) {
        element && extractInputs(element, resultArray);
      }
    }
    return resultArray;
  }
  return {
    start: function start(mapperID, worklet, inputs, outputs) {
      var mapper = {
        id: mapperID,
        dirty: true,
        worklet: worklet,
        inputs: extractInputs(inputs, []),
        outputs: outputs
      };
      mappers.set(mapper.id, mapper);
      sortedMappers = [];
      for (var sv of mapper.inputs) {
        sv.addListener(mapper.id, function () {
          mapper.dirty = true;
          maybeRequestUpdates();
        });
      }
      maybeRequestUpdates();
    },
    stop: function stop(mapperID) {
      var mapper = mappers.get(mapperID);
      if (mapper) {
        mappers.delete(mapper.id);
        sortedMappers = [];
        for (var sv of mapper.inputs) {
          sv.removeListener(mapper.id);
        }
      }
    }
  };
}
var MAPPER_ID = 9999;
function startMapper(worklet) {
  var inputs = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var outputs = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  var mapperID = MAPPER_ID += 1;
  (0, _threads.runOnUI)(function () {
    var mapperRegistry = global.__mapperRegistry;
    if (mapperRegistry === undefined) {
      mapperRegistry = global.__mapperRegistry = createMapperRegistry();
    }
    mapperRegistry.start(mapperID, worklet, inputs, outputs);
  })();
  return mapperID;
}
function stopMapper(mapperID) {
  (0, _threads.runOnUI)(function () {
    var mapperRegistry = global.__mapperRegistry;
    mapperRegistry === null || mapperRegistry === void 0 ? void 0 : mapperRegistry.stop(mapperID);
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfUGxhdGZvcm1DaGVja2VyIiwicmVxdWlyZSIsIl90aHJlYWRzIiwiX3V0aWxzIiwiSVNfSkVTVCIsImlzSmVzdCIsImNyZWF0ZU1hcHBlclJlZ2lzdHJ5IiwibWFwcGVycyIsIk1hcCIsInNvcnRlZE1hcHBlcnMiLCJydW5SZXF1ZXN0ZWQiLCJwcm9jZXNzaW5nTWFwcGVycyIsInVwZGF0ZU1hcHBlcnNPcmRlciIsInByZSIsImZvckVhY2giLCJtYXBwZXIiLCJvdXRwdXRzIiwib3V0cHV0IiwicHJlTWFwcGVycyIsImdldCIsInVuZGVmaW5lZCIsInNldCIsInB1c2giLCJ2aXNpdGVkIiwiU2V0IiwibmV3T3JkZXIiLCJkZnMiLCJhZGQiLCJpbnB1dCIsImlucHV0cyIsInByZU1hcHBlciIsImhhcyIsIm1hcHBlclJ1biIsInNpemUiLCJsZW5ndGgiLCJkaXJ0eSIsIndvcmtsZXQiLCJtYXliZVJlcXVlc3RVcGRhdGVzIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicXVldWVNaWNyb3Rhc2siLCJleHRyYWN0SW5wdXRzIiwicmVzdWx0QXJyYXkiLCJBcnJheSIsImlzQXJyYXkiLCJpc1NoYXJlZFZhbHVlIiwiT2JqZWN0IiwiZ2V0UHJvdG90eXBlT2YiLCJwcm90b3R5cGUiLCJlbGVtZW50IiwidmFsdWVzIiwic3RhcnQiLCJtYXBwZXJJRCIsImlkIiwic3YiLCJhZGRMaXN0ZW5lciIsInN0b3AiLCJkZWxldGUiLCJyZW1vdmVMaXN0ZW5lciIsIk1BUFBFUl9JRCIsInN0YXJ0TWFwcGVyIiwiYXJndW1lbnRzIiwicnVuT25VSSIsIm1hcHBlclJlZ2lzdHJ5IiwiZ2xvYmFsIiwiX19tYXBwZXJSZWdpc3RyeSIsInN0b3BNYXBwZXIiXSwic291cmNlcyI6WyJtYXBwZXJzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgU2hhcmVkVmFsdWUgfSBmcm9tICcuL2NvbW1vblR5cGVzJztcbmltcG9ydCB7IGlzSmVzdCB9IGZyb20gJy4vUGxhdGZvcm1DaGVja2VyJztcbmltcG9ydCB7IHJ1bk9uVUkgfSBmcm9tICcuL3RocmVhZHMnO1xuaW1wb3J0IHsgaXNTaGFyZWRWYWx1ZSB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBJU19KRVNUID0gaXNKZXN0KCk7XG5cbmV4cG9ydCB0eXBlIE1hcHBlciA9IHtcbiAgaWQ6IG51bWJlcjtcbiAgZGlydHk6IGJvb2xlYW47XG4gIHdvcmtsZXQ6ICgpID0+IHZvaWQ7XG4gIGlucHV0czogU2hhcmVkVmFsdWU8YW55PltdO1xuICBvdXRwdXRzPzogU2hhcmVkVmFsdWU8YW55PltdO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU1hcHBlclJlZ2lzdHJ5KCkge1xuICAnd29ya2xldCc7XG4gIGNvbnN0IG1hcHBlcnMgPSBuZXcgTWFwKCk7XG4gIGxldCBzb3J0ZWRNYXBwZXJzOiBNYXBwZXJbXSA9IFtdO1xuXG4gIGxldCBydW5SZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgbGV0IHByb2Nlc3NpbmdNYXBwZXJzID0gZmFsc2U7XG5cbiAgZnVuY3Rpb24gdXBkYXRlTWFwcGVyc09yZGVyKCkge1xuICAgIC8vIHNvcnQgbWFwcGVycyB0b3BvbG9naWNhbGx5XG4gICAgLy8gdGhlIGFsZ29yaXRobSBoZXJlIHRha2VzIGFkdmVudGFnZSBvZiBhIGZhY3QgdGhhdCB0aGUgdG9wb2xvZ2ljYWwgb3JkZXJcbiAgICAvLyBvZiBhIHRyYW5zcG9zZWQgZ3JhcGggaXMgYSByZXZlcnNlIHRvcG9sb2dpY2FsIG9yZGVyIG9mIHRoZSBvcmlnaW5hbCBncmFwaFxuICAgIC8vIFRoZSBncmFwaCBpbiBvdXIgY2FzZSBjb25zaXN0cyBvZiBtYXBwZXJzIGFuZCBhbiBlZGdlIGJldHdlZW4gdHdvIG1hcHBlcnNcbiAgICAvLyBBIGFuZCBCIGV4aXN0cyBpZiB0aGVyZSBpcyBhIHNoYXJlZCB2YWx1ZSB0aGF0J3Mgb24gQSdzIG91dHB1dCBsaXN0cyBhbmQgb25cbiAgICAvLyBCJ3MgaW5wdXQgbGlzdC5cbiAgICAvL1xuICAgIC8vIFdlIGRvbid0IG5lZWQgaG93ZXZlciB0byBjYWxjdWxhdGUgdGhhdCBncmFwaCBhcyBpdCBpcyBlYXNpZXIgdG8gd29yayB3aXRoXG4gICAgLy8gdGhlIHRyYW5zcG9zZWQgdmVyc2lvbiBvZiBpdCB0aGF0IGNhbiBiZSBjYWxjdWxhdGVkIGFkLWhvYy4gRm9yIHRoZSB0cmFuc3Bvc2VkXG4gICAgLy8gdmVyc2lvbiB0byBiZSB0cmF2ZXJzZWQgd2UgdXNlIFwicHJlXCIgbWFwIHRoYXQgbWFwcyBzaGFyZSB2YWx1ZSB0byBtYXBwZXJzIHRoYXRcbiAgICAvLyBvdXRwdXQgdGhhdCBzaGFyZWQgdmFsdWUuIFRoZW4gd2UgY2FuIGluZmVyIGFsbCB0aGUgb3V0Z29pbmcgZWRnZXMgZm9yIGEgZ2l2ZW5cbiAgICAvLyBtYXBwZXIgc2ltcGx5IGJ5IHNjYW5uaW5nIGl0J3MgaW5wdXQgbGlzdCBhbmQgY2hlY2tpbmcgaWYgYW55IG9mIHRoZSBzaGFyZWQgdmFsdWVzXG4gICAgLy8gZnJvbSB0aGF0IGxpc3QgZXhpc3RzIGluIHRoZSBcInByZVwiIG1hcC4gSWYgdGhleSBkbywgdGhlbiB3ZSBoYXZlIGFuIGVkZ2UgYmV0d2VlblxuICAgIC8vIHRoYXQgbWFwcGVyIGFuZCB0aGUgbWFwcGVycyBmcm9tIHRoZSBcInByZVwiIGxpc3QgZm9yIHRoZSBnaXZlbiBzaGFyZWQgdmFsdWUuXG4gICAgLy9cbiAgICAvLyBGb3IgdG9wb2xvZ2ljYWwgc29ydGluZyB3ZSB1c2UgYSBkZnMtYmFzZWQgYXBwcm9hY2ggdGhhdCByZXF1aXJlcyB0aGUgZ3JhcGggdG9cbiAgICAvLyBiZSB0cmF2ZXJzZWQgaW4gZGZzIG9yZGVyIGFuZCBlYWNoIG5vZGUgYWZ0ZXIgYmVpbmcgcHJvY2Vzc2VkIGxhbmRzIGF0IHRoZVxuICAgIC8vIGJlZ2lubmluZyBvZiB0aGUgdG9wb2xvZ2ljYWwgb3JkZXIgbGlzdC4gU2luY2Ugd2UgdHJhdmVyc2UgYSB0cmFuc3Bvc2VkIGdyYXBoLFxuICAgIC8vIGluc3RlYWQgb2YgcmV2ZXJzaW5nIHRoYXQgb3JkZXIgd2UgY2FuIHVzZSBhIG5vcm1hbCBhcnJheSBhbmQgcHVzaCBwcm9jZXNzZWRcbiAgICAvLyBtYXBwZXJzIHRvIHRoZSBlbmQuIFRoZXJlIGlzIG5vIG5lZWQgdG8gcmV2ZXJzZSB0aGF0IGFycmF5IGFmdGVyIHdlIGFyZSBkb25lLlxuICAgIGNvbnN0IHByZSA9IG5ldyBNYXAoKTsgLy8gbWFwIGZyb20gc3YgLT4gbWFwcGVyIHRoYXQgb3V0cHV0cyB0aGF0IHN2XG4gICAgbWFwcGVycy5mb3JFYWNoKChtYXBwZXIpID0+IHtcbiAgICAgIGlmIChtYXBwZXIub3V0cHV0cykge1xuICAgICAgICBmb3IgKGNvbnN0IG91dHB1dCBvZiBtYXBwZXIub3V0cHV0cykge1xuICAgICAgICAgIGNvbnN0IHByZU1hcHBlcnMgPSBwcmUuZ2V0KG91dHB1dCk7XG4gICAgICAgICAgaWYgKHByZU1hcHBlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcHJlLnNldChvdXRwdXQsIFttYXBwZXJdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJlTWFwcGVycy5wdXNoKG1hcHBlcik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCBuZXdPcmRlcjogTWFwcGVyW10gPSBbXTtcbiAgICBmdW5jdGlvbiBkZnMobWFwcGVyOiBNYXBwZXIpIHtcbiAgICAgIHZpc2l0ZWQuYWRkKG1hcHBlcik7XG4gICAgICBmb3IgKGNvbnN0IGlucHV0IG9mIG1hcHBlci5pbnB1dHMpIHtcbiAgICAgICAgY29uc3QgcHJlTWFwcGVycyA9IHByZS5nZXQoaW5wdXQpO1xuICAgICAgICBpZiAocHJlTWFwcGVycykge1xuICAgICAgICAgIGZvciAoY29uc3QgcHJlTWFwcGVyIG9mIHByZU1hcHBlcnMpIHtcbiAgICAgICAgICAgIGlmICghdmlzaXRlZC5oYXMocHJlTWFwcGVyKSkge1xuICAgICAgICAgICAgICBkZnMocHJlTWFwcGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG5ld09yZGVyLnB1c2gobWFwcGVyKTtcbiAgICB9XG4gICAgbWFwcGVycy5mb3JFYWNoKChtYXBwZXIpID0+IHtcbiAgICAgIGlmICghdmlzaXRlZC5oYXMobWFwcGVyKSkge1xuICAgICAgICBkZnMobWFwcGVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBzb3J0ZWRNYXBwZXJzID0gbmV3T3JkZXI7XG4gIH1cblxuICBmdW5jdGlvbiBtYXBwZXJSdW4oKSB7XG4gICAgcnVuUmVxdWVzdGVkID0gZmFsc2U7XG4gICAgaWYgKHByb2Nlc3NpbmdNYXBwZXJzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHByb2Nlc3NpbmdNYXBwZXJzID0gdHJ1ZTtcbiAgICBpZiAobWFwcGVycy5zaXplICE9PSBzb3J0ZWRNYXBwZXJzLmxlbmd0aCkge1xuICAgICAgdXBkYXRlTWFwcGVyc09yZGVyKCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgbWFwcGVyIG9mIHNvcnRlZE1hcHBlcnMpIHtcbiAgICAgIGlmIChtYXBwZXIuZGlydHkpIHtcbiAgICAgICAgbWFwcGVyLmRpcnR5ID0gZmFsc2U7XG4gICAgICAgIG1hcHBlci53b3JrbGV0KCk7XG4gICAgICB9XG4gICAgfVxuICAgIHByb2Nlc3NpbmdNYXBwZXJzID0gZmFsc2U7XG4gIH1cblxuICBmdW5jdGlvbiBtYXliZVJlcXVlc3RVcGRhdGVzKCkge1xuICAgIGlmIChJU19KRVNUKSB7XG4gICAgICAvLyBPbiBKZXN0IGVudmlyb25tZW50IHdlIGF2b2lkIHVzaW5nIHF1ZXVlTWljcm90YXNrIGFzIHRoYXQnZCByZXF1aXJlIHRlc3RcbiAgICAgIC8vIHRvIGFkdmFuY2UgdGhlIGNsb2NrIG1hbnVhbGx5LiBUaGlzIG9uIG90aGVyIGhhbmQgd291bGQgcmVxdWlyZSB0ZXN0c1xuICAgICAgLy8gdG8ga25vdyBob3cgbWFueSB0aW1lcyBtYXBwZXJzIG5lZWQgdG8gcnVuLiBBcyB3ZSBkb24ndCB3YW50IHRlc3RzIHRvXG4gICAgICAvLyBtYWtlIGFueSBhc3N1bXB0aW9ucyBvbiB0aGF0IG51bWJlciBpdCBpcyBlYXNpZXIgdG8gZXhlY3V0ZSBtYXBwZXJzXG4gICAgICAvLyBpbW1lZGlhdGVseSBmb3IgdGVzdGluZyBwdXJwb3NlcyBhbmQgb25seSBleHBlY3QgdGVzdCB0byBhZHZhbmNlIHRpbWVyc1xuICAgICAgLy8gaWYgdGhleSB3YW50IHRvIG1ha2UgYW55IGFzc2VydGlvbnMgb24gdGhlIGVmZmVjdHMgb2YgYW5pbWF0aW9ucyBiZWluZyBydW4uXG4gICAgICBtYXBwZXJSdW4oKTtcbiAgICB9IGVsc2UgaWYgKCFydW5SZXF1ZXN0ZWQpIHtcbiAgICAgIGlmIChwcm9jZXNzaW5nTWFwcGVycykge1xuICAgICAgICAvLyBJbiBnZW5lcmFsLCB3ZSBzaG91bGQgYXZvaWQgaGF2aW5nIG1hcHBlcnMgdHJpZ2dlciB1cGRhdGVzIGFzIHRoaXMgbWF5XG4gICAgICAgIC8vIHJlc3VsdCBpbiB1bnByZWRpY3RhYmxlIGJlaGF2aW9yLiBTcGVjaWZpY2FsbHksIHRoZSB1cGRhdGVkIHZhbHVlIGNhblxuICAgICAgICAvLyBiZSByZWFkIGJ5IG1hcHBlcnMgdGhhdCBydW4gbGF0ZXIgaW4gdGhlIHNhbWUgZnJhbWUgYnV0IHByZXZpb3VzIG1hcHBlcnNcbiAgICAgICAgLy8gd291bGQgYWNjZXNzIHRoZSBvbGQgdmFsdWUuIFVwZGF0aW5nIG1hcHBlcnMgZHVyaW5nIHRoZSBtYXBwZXItcnVuIHBoYXNlXG4gICAgICAgIC8vIGJyZWFrcyB0aGUgb3JkZXIgaW4gd2hpY2ggd2Ugc2hvdWxkIGV4ZWN1dGUgdGhlIG1hcHBlcnMuIEhvd2V2ZXIsIGRvaW5nXG4gICAgICAgIC8vIHRoYXQgaXMgc3RpbGwgYSBwb3NzaWJpbGl0eSBhbmQgdGhlcmUgYXJlIHNvbWUgaW5zdGFuY2VzIHdoZXJlIHBlb3BsZSB1c2VcbiAgICAgICAgLy8gdGhlIEFQSSBpbiB0aGF0IHdheSwgaGVuY2Ugd2UgbmVlZCB0byBwcmV2ZW50IG1hcHBlci1ydW4gcGhhc2UgZmFsbGluZyBpbnRvXG4gICAgICAgIC8vIGFuIGluZmluaXRlIGxvb3AuIFdlIGRvIHRoYXQgYnkgZGV0ZWN0aW5nIHdoZW4gbWFwcGVyLXJ1biBpcyByZXF1ZXN0ZWQgd2hpbGVcbiAgICAgICAgLy8gd2UgYXJlIGFscmVhZHkgaW4gbWFwcGVyLXJ1biBwaGFzZSwgYW5kIGluIHRoYXQgY2FzZSB3ZSB1c2UgYHJlcXVlc3RBbmltYXRpb25GcmFtZWBcbiAgICAgICAgLy8gaW5zdGVhZCBvZiBgcXVldWVNaWNyb3Rhc2tgIHdoaWNoIHdpbGwgc2NoZWR1bGUgbWFwcGVyIHJ1biBmb3IgdGhlIG5leHRcbiAgICAgICAgLy8gZnJhbWUgaW5zdGVhZCBvZiBxdWV1aW5nIGFub3RoZXIgc2V0IG9mIHVwZGF0ZXMgaW4gdGhlIHNhbWUgZnJhbWUuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShtYXBwZXJSdW4pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcXVldWVNaWNyb3Rhc2sobWFwcGVyUnVuKTtcbiAgICAgIH1cbiAgICAgIHJ1blJlcXVlc3RlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZXh0cmFjdElucHV0cyhcbiAgICBpbnB1dHM6IGFueSxcbiAgICByZXN1bHRBcnJheTogU2hhcmVkVmFsdWU8YW55PltdXG4gICk6IFNoYXJlZFZhbHVlPGFueT5bXSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaW5wdXRzKSkge1xuICAgICAgZm9yIChjb25zdCBpbnB1dCBvZiBpbnB1dHMpIHtcbiAgICAgICAgaW5wdXQgJiYgZXh0cmFjdElucHV0cyhpbnB1dCwgcmVzdWx0QXJyYXkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNTaGFyZWRWYWx1ZShpbnB1dHMpKSB7XG4gICAgICByZXN1bHRBcnJheS5wdXNoKGlucHV0cyk7XG4gICAgfSBlbHNlIGlmIChPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5wdXRzKSA9PT0gT2JqZWN0LnByb3RvdHlwZSkge1xuICAgICAgLy8gd2Ugb25seSBleHRyYWN0IGlucHV0cyByZWN1cnNpdmVseSBmcm9tIFwicGxhaW5cIiBvYmplY3RzIGhlcmUsIGlmIG9iamVjdFxuICAgICAgLy8gaXMgb2YgYSBkZXJpdmF0aXZlIGNsYXNzIChlLmcuIEhvc3RPYmplY3Qgb24gd2ViLCBvciBNYXApIHdlIGRvbid0IHNjYW5cbiAgICAgIC8vIGl0IHJlY3Vyc2l2ZWx5XG4gICAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgT2JqZWN0LnZhbHVlcyhpbnB1dHMpKSB7XG4gICAgICAgIGVsZW1lbnQgJiYgZXh0cmFjdElucHV0cyhlbGVtZW50LCByZXN1bHRBcnJheSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRBcnJheTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3RhcnQ6IChcbiAgICAgIG1hcHBlcklEOiBudW1iZXIsXG4gICAgICB3b3JrbGV0OiAoKSA9PiB2b2lkLFxuICAgICAgaW5wdXRzOiBTaGFyZWRWYWx1ZTxhbnk+W10sXG4gICAgICBvdXRwdXRzPzogU2hhcmVkVmFsdWU8YW55PltdXG4gICAgKSA9PiB7XG4gICAgICBjb25zdCBtYXBwZXIgPSB7XG4gICAgICAgIGlkOiBtYXBwZXJJRCxcbiAgICAgICAgZGlydHk6IHRydWUsXG4gICAgICAgIHdvcmtsZXQsXG4gICAgICAgIGlucHV0czogZXh0cmFjdElucHV0cyhpbnB1dHMsIFtdKSxcbiAgICAgICAgb3V0cHV0cyxcbiAgICAgIH07XG4gICAgICBtYXBwZXJzLnNldChtYXBwZXIuaWQsIG1hcHBlcik7XG4gICAgICBzb3J0ZWRNYXBwZXJzID0gW107XG4gICAgICBmb3IgKGNvbnN0IHN2IG9mIG1hcHBlci5pbnB1dHMpIHtcbiAgICAgICAgc3YuYWRkTGlzdGVuZXIobWFwcGVyLmlkLCAoKSA9PiB7XG4gICAgICAgICAgbWFwcGVyLmRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICBtYXliZVJlcXVlc3RVcGRhdGVzKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbWF5YmVSZXF1ZXN0VXBkYXRlcygpO1xuICAgIH0sXG4gICAgc3RvcDogKG1hcHBlcklEOiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IG1hcHBlciA9IG1hcHBlcnMuZ2V0KG1hcHBlcklEKTtcbiAgICAgIGlmIChtYXBwZXIpIHtcbiAgICAgICAgbWFwcGVycy5kZWxldGUobWFwcGVyLmlkKTtcbiAgICAgICAgc29ydGVkTWFwcGVycyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHN2IG9mIG1hcHBlci5pbnB1dHMpIHtcbiAgICAgICAgICBzdi5yZW1vdmVMaXN0ZW5lcihtYXBwZXIuaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcbiAgfTtcbn1cblxubGV0IE1BUFBFUl9JRCA9IDk5OTk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFydE1hcHBlcihcbiAgd29ya2xldDogKCkgPT4gdm9pZCxcbiAgaW5wdXRzOiBhbnlbXSA9IFtdLFxuICBvdXRwdXRzOiBhbnlbXSA9IFtdXG4pOiBudW1iZXIge1xuICBjb25zdCBtYXBwZXJJRCA9IChNQVBQRVJfSUQgKz0gMSk7XG5cbiAgcnVuT25VSSgoKSA9PiB7XG4gICAgbGV0IG1hcHBlclJlZ2lzdHJ5ID0gZ2xvYmFsLl9fbWFwcGVyUmVnaXN0cnk7XG4gICAgaWYgKG1hcHBlclJlZ2lzdHJ5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG1hcHBlclJlZ2lzdHJ5ID0gZ2xvYmFsLl9fbWFwcGVyUmVnaXN0cnkgPSBjcmVhdGVNYXBwZXJSZWdpc3RyeSgpO1xuICAgIH1cbiAgICBtYXBwZXJSZWdpc3RyeS5zdGFydChtYXBwZXJJRCwgd29ya2xldCwgaW5wdXRzLCBvdXRwdXRzKTtcbiAgfSkoKTtcblxuICByZXR1cm4gbWFwcGVySUQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wTWFwcGVyKG1hcHBlcklEOiBudW1iZXIpOiB2b2lkIHtcbiAgcnVuT25VSSgoKSA9PiB7XG4gICAgY29uc3QgbWFwcGVyUmVnaXN0cnkgPSBnbG9iYWwuX19tYXBwZXJSZWdpc3RyeTtcbiAgICBtYXBwZXJSZWdpc3RyeT8uc3RvcChtYXBwZXJJRCk7XG4gIH0pKCk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQUFBLGdCQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxRQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxNQUFBLEdBQUFGLE9BQUE7QUFFQSxJQUFNRyxPQUFPLEdBQUcsSUFBQUMsdUJBQU0sR0FBRTtBQVVqQixTQUFTQyxvQkFBb0JBLENBQUEsRUFBRztFQUNyQyxTQUFTOztFQUNULElBQU1DLE9BQU8sR0FBRyxJQUFJQyxHQUFHLEVBQUU7RUFDekIsSUFBSUMsYUFBdUIsR0FBRyxFQUFFO0VBRWhDLElBQUlDLFlBQVksR0FBRyxLQUFLO0VBQ3hCLElBQUlDLGlCQUFpQixHQUFHLEtBQUs7RUFFN0IsU0FBU0Msa0JBQWtCQSxDQUFBLEVBQUc7SUFxQjVCLElBQU1DLEdBQUcsR0FBRyxJQUFJTCxHQUFHLEVBQUU7SUFDckJELE9BQU8sQ0FBQ08sT0FBTyxDQUFFLFVBQUFDLE1BQU0sRUFBSztNQUMxQixJQUFJQSxNQUFNLENBQUNDLE9BQU8sRUFBRTtRQUNsQixLQUFLLElBQU1DLE1BQU0sSUFBSUYsTUFBTSxDQUFDQyxPQUFPLEVBQUU7VUFDbkMsSUFBTUUsVUFBVSxHQUFHTCxHQUFHLENBQUNNLEdBQUcsQ0FBQ0YsTUFBTSxDQUFDO1VBQ2xDLElBQUlDLFVBQVUsS0FBS0UsU0FBUyxFQUFFO1lBQzVCUCxHQUFHLENBQUNRLEdBQUcsQ0FBQ0osTUFBTSxFQUFFLENBQUNGLE1BQU0sQ0FBQyxDQUFDO1VBQzNCLENBQUMsTUFBTTtZQUNMRyxVQUFVLENBQUNJLElBQUksQ0FBQ1AsTUFBTSxDQUFDO1VBQ3pCO1FBQ0Y7TUFDRjtJQUNGLENBQUMsQ0FBQztJQUNGLElBQU1RLE9BQU8sR0FBRyxJQUFJQyxHQUFHLEVBQUU7SUFDekIsSUFBTUMsUUFBa0IsR0FBRyxFQUFFO0lBQzdCLFNBQVNDLEdBQUdBLENBQUNYLE1BQWMsRUFBRTtNQUMzQlEsT0FBTyxDQUFDSSxHQUFHLENBQUNaLE1BQU0sQ0FBQztNQUNuQixLQUFLLElBQU1hLEtBQUssSUFBSWIsTUFBTSxDQUFDYyxNQUFNLEVBQUU7UUFDakMsSUFBTVgsVUFBVSxHQUFHTCxHQUFHLENBQUNNLEdBQUcsQ0FBQ1MsS0FBSyxDQUFDO1FBQ2pDLElBQUlWLFVBQVUsRUFBRTtVQUNkLEtBQUssSUFBTVksU0FBUyxJQUFJWixVQUFVLEVBQUU7WUFDbEMsSUFBSSxDQUFDSyxPQUFPLENBQUNRLEdBQUcsQ0FBQ0QsU0FBUyxDQUFDLEVBQUU7Y0FDM0JKLEdBQUcsQ0FBQ0ksU0FBUyxDQUFDO1lBQ2hCO1VBQ0Y7UUFDRjtNQUNGO01BQ0FMLFFBQVEsQ0FBQ0gsSUFBSSxDQUFDUCxNQUFNLENBQUM7SUFDdkI7SUFDQVIsT0FBTyxDQUFDTyxPQUFPLENBQUUsVUFBQUMsTUFBTSxFQUFLO01BQzFCLElBQUksQ0FBQ1EsT0FBTyxDQUFDUSxHQUFHLENBQUNoQixNQUFNLENBQUMsRUFBRTtRQUN4QlcsR0FBRyxDQUFDWCxNQUFNLENBQUM7TUFDYjtJQUNGLENBQUMsQ0FBQztJQUNGTixhQUFhLEdBQUdnQixRQUFRO0VBQzFCO0VBRUEsU0FBU08sU0FBU0EsQ0FBQSxFQUFHO0lBQ25CdEIsWUFBWSxHQUFHLEtBQUs7SUFDcEIsSUFBSUMsaUJBQWlCLEVBQUU7TUFDckI7SUFDRjtJQUNBQSxpQkFBaUIsR0FBRyxJQUFJO0lBQ3hCLElBQUlKLE9BQU8sQ0FBQzBCLElBQUksS0FBS3hCLGFBQWEsQ0FBQ3lCLE1BQU0sRUFBRTtNQUN6Q3RCLGtCQUFrQixFQUFFO0lBQ3RCO0lBQ0EsS0FBSyxJQUFNRyxNQUFNLElBQUlOLGFBQWEsRUFBRTtNQUNsQyxJQUFJTSxNQUFNLENBQUNvQixLQUFLLEVBQUU7UUFDaEJwQixNQUFNLENBQUNvQixLQUFLLEdBQUcsS0FBSztRQUNwQnBCLE1BQU0sQ0FBQ3FCLE9BQU8sRUFBRTtNQUNsQjtJQUNGO0lBQ0F6QixpQkFBaUIsR0FBRyxLQUFLO0VBQzNCO0VBRUEsU0FBUzBCLG1CQUFtQkEsQ0FBQSxFQUFHO0lBQzdCLElBQUlqQyxPQUFPLEVBQUU7TUFPWDRCLFNBQVMsRUFBRTtJQUNiLENBQUMsTUFBTSxJQUFJLENBQUN0QixZQUFZLEVBQUU7TUFDeEIsSUFBSUMsaUJBQWlCLEVBQUU7UUFZckIyQixxQkFBcUIsQ0FBQ04sU0FBUyxDQUFDO01BQ2xDLENBQUMsTUFBTTtRQUNMTyxjQUFjLENBQUNQLFNBQVMsQ0FBQztNQUMzQjtNQUNBdEIsWUFBWSxHQUFHLElBQUk7SUFDckI7RUFDRjtFQUVBLFNBQVM4QixhQUFhQSxDQUNwQlgsTUFBVyxFQUNYWSxXQUErQixFQUNYO0lBQ3BCLElBQUlDLEtBQUssQ0FBQ0MsT0FBTyxDQUFDZCxNQUFNLENBQUMsRUFBRTtNQUN6QixLQUFLLElBQU1ELEtBQUssSUFBSUMsTUFBTSxFQUFFO1FBQzFCRCxLQUFLLElBQUlZLGFBQWEsQ0FBQ1osS0FBSyxFQUFFYSxXQUFXLENBQUM7TUFDNUM7SUFDRixDQUFDLE1BQU0sSUFBSSxJQUFBRyxvQkFBYSxFQUFDZixNQUFNLENBQUMsRUFBRTtNQUNoQ1ksV0FBVyxDQUFDbkIsSUFBSSxDQUFDTyxNQUFNLENBQUM7SUFDMUIsQ0FBQyxNQUFNLElBQUlnQixNQUFNLENBQUNDLGNBQWMsQ0FBQ2pCLE1BQU0sQ0FBQyxLQUFLZ0IsTUFBTSxDQUFDRSxTQUFTLEVBQUU7TUFJN0QsS0FBSyxJQUFNQyxPQUFPLElBQUlILE1BQU0sQ0FBQ0ksTUFBTSxDQUFDcEIsTUFBTSxDQUFDLEVBQUU7UUFDM0NtQixPQUFPLElBQUlSLGFBQWEsQ0FBQ1EsT0FBTyxFQUFFUCxXQUFXLENBQUM7TUFDaEQ7SUFDRjtJQUNBLE9BQU9BLFdBQVc7RUFDcEI7RUFFQSxPQUFPO0lBQ0xTLEtBQUssRUFBRSxTQUFBQSxNQUNMQyxRQUFnQixFQUNoQmYsT0FBbUIsRUFDbkJQLE1BQTBCLEVBQzFCYixPQUE0QixFQUN6QjtNQUNILElBQU1ELE1BQU0sR0FBRztRQUNicUMsRUFBRSxFQUFFRCxRQUFRO1FBQ1poQixLQUFLLEVBQUUsSUFBSTtRQUNYQyxPQUFPLEVBQVBBLE9BQU87UUFDUFAsTUFBTSxFQUFFVyxhQUFhLENBQUNYLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFDakNiLE9BQUEsRUFBQUE7TUFDRixDQUFDO01BQ0RULE9BQU8sQ0FBQ2MsR0FBRyxDQUFDTixNQUFNLENBQUNxQyxFQUFFLEVBQUVyQyxNQUFNLENBQUM7TUFDOUJOLGFBQWEsR0FBRyxFQUFFO01BQ2xCLEtBQUssSUFBTTRDLEVBQUUsSUFBSXRDLE1BQU0sQ0FBQ2MsTUFBTSxFQUFFO1FBQzlCd0IsRUFBRSxDQUFDQyxXQUFXLENBQUN2QyxNQUFNLENBQUNxQyxFQUFFLEVBQUUsWUFBTTtVQUM5QnJDLE1BQU0sQ0FBQ29CLEtBQUssR0FBRyxJQUFJO1VBQ25CRSxtQkFBbUIsRUFBRTtRQUN2QixDQUFDLENBQUM7TUFDSjtNQUNBQSxtQkFBbUIsRUFBRTtJQUN2QixDQUFDO0lBQ0RrQixJQUFJLEVBQUcsU0FBQUEsS0FBQUosUUFBZ0IsRUFBSztNQUMxQixJQUFNcEMsTUFBTSxHQUFHUixPQUFPLENBQUNZLEdBQUcsQ0FBQ2dDLFFBQVEsQ0FBQztNQUNwQyxJQUFJcEMsTUFBTSxFQUFFO1FBQ1ZSLE9BQU8sQ0FBQ2lELE1BQU0sQ0FBQ3pDLE1BQU0sQ0FBQ3FDLEVBQUUsQ0FBQztRQUN6QjNDLGFBQWEsR0FBRyxFQUFFO1FBQ2xCLEtBQUssSUFBTTRDLEVBQUUsSUFBSXRDLE1BQU0sQ0FBQ2MsTUFBTSxFQUFFO1VBQzlCd0IsRUFBRSxDQUFDSSxjQUFjLENBQUMxQyxNQUFNLENBQUNxQyxFQUFFLENBQUM7UUFDOUI7TUFDRjtJQUNGO0VBQ0YsQ0FBQztBQUNIO0FBRUEsSUFBSU0sU0FBUyxHQUFHLElBQUk7QUFFYixTQUFTQyxXQUFXQSxDQUN6QnZCLE9BQW1CLEVBR1g7RUFBQSxJQUZSUCxNQUFhLEdBQUErQixTQUFBLENBQUExQixNQUFBLFFBQUEwQixTQUFBLFFBQUF4QyxTQUFBLEdBQUF3QyxTQUFBLE1BQUcsRUFBRTtFQUFBLElBQ2xCNUMsT0FBYyxHQUFBNEMsU0FBQSxDQUFBMUIsTUFBQSxRQUFBMEIsU0FBQSxRQUFBeEMsU0FBQSxHQUFBd0MsU0FBQSxNQUFHLEVBQUU7RUFFbkIsSUFBTVQsUUFBUSxHQUFJTyxTQUFTLElBQUksQ0FBRTtFQUVqQyxJQUFBRyxnQkFBTyxFQUFDLFlBQU07SUFDWixJQUFJQyxjQUFjLEdBQUdDLE1BQU0sQ0FBQ0MsZ0JBQWdCO0lBQzVDLElBQUlGLGNBQWMsS0FBSzFDLFNBQVMsRUFBRTtNQUNoQzBDLGNBQWMsR0FBR0MsTUFBTSxDQUFDQyxnQkFBZ0IsR0FBRzFELG9CQUFvQixFQUFFO0lBQ25FO0lBQ0F3RCxjQUFjLENBQUNaLEtBQUssQ0FBQ0MsUUFBUSxFQUFFZixPQUFPLEVBQUVQLE1BQU0sRUFBRWIsT0FBTyxDQUFDO0VBQzFELENBQUMsQ0FBQyxFQUFFO0VBRUosT0FBT21DLFFBQVE7QUFDakI7QUFFTyxTQUFTYyxVQUFVQSxDQUFDZCxRQUFnQixFQUFRO0VBQ2pELElBQUFVLGdCQUFPLEVBQUMsWUFBTTtJQUNaLElBQU1DLGNBQWMsR0FBR0MsTUFBTSxDQUFDQyxnQkFBZ0I7SUFDOUNGLGNBQWMsYUFBZEEsY0FBYyx1QkFBZEEsY0FBYyxDQUFFUCxJQUFJLENBQUNKLFFBQVEsQ0FBQztFQUNoQyxDQUFDLENBQUMsRUFBRTtBQUNOIn0=