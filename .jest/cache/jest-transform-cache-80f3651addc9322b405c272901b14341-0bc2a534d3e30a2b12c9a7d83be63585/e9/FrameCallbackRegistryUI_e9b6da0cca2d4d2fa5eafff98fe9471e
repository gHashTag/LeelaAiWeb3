ed1abc05dff0f56b26c9ebcb94120390
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.prepareUIRegistry = void 0;
var _threads = require("../threads");
var prepareUIRegistry = (0, _threads.runOnUIImmediately)(function () {
  'worklet';

  var frameCallbackRegistry = {
    frameCallbackRegistry: new Map(),
    activeFrameCallbacks: new Set(),
    previousFrameTimestamp: null,
    nextCallId: 0,
    runCallbacks: function runCallbacks(callId) {
      var _this = this;
      var loop = function loop(timestamp) {
        if (callId !== _this.nextCallId) {
          return;
        }
        if (_this.previousFrameTimestamp === null) {
          _this.previousFrameTimestamp = timestamp;
        }
        var delta = timestamp - _this.previousFrameTimestamp;
        _this.activeFrameCallbacks.forEach(function (callbackId) {
          var callbackDetails = _this.frameCallbackRegistry.get(callbackId);
          var startTime = callbackDetails.startTime;
          if (startTime === null) {
            callbackDetails.startTime = timestamp;
            callbackDetails.callback({
              timestamp: timestamp,
              timeSincePreviousFrame: null,
              timeSinceFirstFrame: 0
            });
          } else {
            callbackDetails.callback({
              timestamp: timestamp,
              timeSincePreviousFrame: delta,
              timeSinceFirstFrame: timestamp - startTime
            });
          }
        });
        if (_this.activeFrameCallbacks.size > 0) {
          _this.previousFrameTimestamp = timestamp;
          requestAnimationFrame(loop);
        } else {
          _this.previousFrameTimestamp = null;
        }
      };
      if (this.activeFrameCallbacks.size === 1 && callId === this.nextCallId) {
        requestAnimationFrame(loop);
      }
    },
    registerFrameCallback: function registerFrameCallback(callback, callbackId) {
      this.frameCallbackRegistry.set(callbackId, {
        callback: callback,
        startTime: null
      });
    },
    unregisterFrameCallback: function unregisterFrameCallback(callbackId) {
      this.manageStateFrameCallback(callbackId, false);
      this.frameCallbackRegistry.delete(callbackId);
    },
    manageStateFrameCallback: function manageStateFrameCallback(callbackId, state) {
      if (callbackId === -1) {
        return;
      }
      if (state) {
        this.activeFrameCallbacks.add(callbackId);
        this.runCallbacks(this.nextCallId);
      } else {
        var callback = this.frameCallbackRegistry.get(callbackId);
        callback.startTime = null;
        this.activeFrameCallbacks.delete(callbackId);
        if (this.activeFrameCallbacks.size === 0) {
          this.nextCallId += 1;
        }
      }
    }
  };
  global._frameCallbackRegistry = frameCallbackRegistry;
});
exports.prepareUIRegistry = prepareUIRegistry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdGhyZWFkcyIsInJlcXVpcmUiLCJwcmVwYXJlVUlSZWdpc3RyeSIsInJ1bk9uVUlJbW1lZGlhdGVseSIsImZyYW1lQ2FsbGJhY2tSZWdpc3RyeSIsIk1hcCIsImFjdGl2ZUZyYW1lQ2FsbGJhY2tzIiwiU2V0IiwicHJldmlvdXNGcmFtZVRpbWVzdGFtcCIsIm5leHRDYWxsSWQiLCJydW5DYWxsYmFja3MiLCJjYWxsSWQiLCJfdGhpcyIsImxvb3AiLCJ0aW1lc3RhbXAiLCJkZWx0YSIsImZvckVhY2giLCJjYWxsYmFja0lkIiwiY2FsbGJhY2tEZXRhaWxzIiwiZ2V0Iiwic3RhcnRUaW1lIiwiY2FsbGJhY2siLCJ0aW1lU2luY2VQcmV2aW91c0ZyYW1lIiwidGltZVNpbmNlRmlyc3RGcmFtZSIsInNpemUiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJyZWdpc3RlckZyYW1lQ2FsbGJhY2siLCJzZXQiLCJ1bnJlZ2lzdGVyRnJhbWVDYWxsYmFjayIsIm1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjayIsImRlbGV0ZSIsInN0YXRlIiwiYWRkIiwiZ2xvYmFsIiwiX2ZyYW1lQ2FsbGJhY2tSZWdpc3RyeSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJGcmFtZUNhbGxiYWNrUmVnaXN0cnlVSS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBydW5PblVJSW1tZWRpYXRlbHkgfSBmcm9tICcuLi90aHJlYWRzJztcblxudHlwZSBDYWxsYmFja0RldGFpbHMgPSB7XG4gIGNhbGxiYWNrOiAoZnJhbWVJbmZvOiBGcmFtZUluZm8pID0+IHZvaWQ7XG4gIHN0YXJ0VGltZTogbnVtYmVyIHwgbnVsbDtcbn07XG5cbmV4cG9ydCB0eXBlIEZyYW1lSW5mbyA9IHtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHRpbWVTaW5jZVByZXZpb3VzRnJhbWU6IG51bWJlciB8IG51bGw7XG4gIHRpbWVTaW5jZUZpcnN0RnJhbWU6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgRnJhbWVDYWxsYmFja1JlZ2lzdHJ5VUkge1xuICBmcmFtZUNhbGxiYWNrUmVnaXN0cnk6IE1hcDxudW1iZXIsIENhbGxiYWNrRGV0YWlscz47XG4gIGFjdGl2ZUZyYW1lQ2FsbGJhY2tzOiBTZXQ8bnVtYmVyPjtcbiAgcHJldmlvdXNGcmFtZVRpbWVzdGFtcDogbnVtYmVyIHwgbnVsbDtcbiAgcnVuQ2FsbGJhY2tzOiAoY2FsbElkOiBudW1iZXIpID0+IHZvaWQ7XG4gIG5leHRDYWxsSWQ6IG51bWJlcjtcbiAgcmVnaXN0ZXJGcmFtZUNhbGxiYWNrOiAoXG4gICAgY2FsbGJhY2s6IChmcmFtZUluZm86IEZyYW1lSW5mbykgPT4gdm9pZCxcbiAgICBjYWxsYmFja0lkOiBudW1iZXJcbiAgKSA9PiB2b2lkO1xuICB1bnJlZ2lzdGVyRnJhbWVDYWxsYmFjazogKGNhbGxiYWNrSWQ6IG51bWJlcikgPT4gdm9pZDtcbiAgbWFuYWdlU3RhdGVGcmFtZUNhbGxiYWNrOiAoY2FsbGJhY2tJZDogbnVtYmVyLCBzdGF0ZTogYm9vbGVhbikgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGNvbnN0IHByZXBhcmVVSVJlZ2lzdHJ5ID0gcnVuT25VSUltbWVkaWF0ZWx5KCgpID0+IHtcbiAgJ3dvcmtsZXQnO1xuXG4gIGNvbnN0IGZyYW1lQ2FsbGJhY2tSZWdpc3RyeTogRnJhbWVDYWxsYmFja1JlZ2lzdHJ5VUkgPSB7XG4gICAgZnJhbWVDYWxsYmFja1JlZ2lzdHJ5OiBuZXcgTWFwPG51bWJlciwgQ2FsbGJhY2tEZXRhaWxzPigpLFxuICAgIGFjdGl2ZUZyYW1lQ2FsbGJhY2tzOiBuZXcgU2V0PG51bWJlcj4oKSxcbiAgICBwcmV2aW91c0ZyYW1lVGltZXN0YW1wOiBudWxsLFxuICAgIG5leHRDYWxsSWQ6IDAsXG5cbiAgICBydW5DYWxsYmFja3MoY2FsbElkKSB7XG4gICAgICBjb25zdCBsb29wID0gKHRpbWVzdGFtcDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmIChjYWxsSWQgIT09IHRoaXMubmV4dENhbGxJZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wcmV2aW91c0ZyYW1lVGltZXN0YW1wID09PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5wcmV2aW91c0ZyYW1lVGltZXN0YW1wID0gdGltZXN0YW1wO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVsdGEgPSB0aW1lc3RhbXAgLSB0aGlzLnByZXZpb3VzRnJhbWVUaW1lc3RhbXA7XG5cbiAgICAgICAgdGhpcy5hY3RpdmVGcmFtZUNhbGxiYWNrcy5mb3JFYWNoKChjYWxsYmFja0lkOiBudW1iZXIpID0+IHtcbiAgICAgICAgICBjb25zdCBjYWxsYmFja0RldGFpbHMgPSB0aGlzLmZyYW1lQ2FsbGJhY2tSZWdpc3RyeS5nZXQoY2FsbGJhY2tJZCkhO1xuXG4gICAgICAgICAgY29uc3QgeyBzdGFydFRpbWUgfSA9IGNhbGxiYWNrRGV0YWlscztcblxuICAgICAgICAgIGlmIChzdGFydFRpbWUgPT09IG51bGwpIHtcbiAgICAgICAgICAgIC8vIEZpcnN0IGZyYW1lXG4gICAgICAgICAgICBjYWxsYmFja0RldGFpbHMuc3RhcnRUaW1lID0gdGltZXN0YW1wO1xuXG4gICAgICAgICAgICBjYWxsYmFja0RldGFpbHMuY2FsbGJhY2soe1xuICAgICAgICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgICAgICAgIHRpbWVTaW5jZVByZXZpb3VzRnJhbWU6IG51bGwsXG4gICAgICAgICAgICAgIHRpbWVTaW5jZUZpcnN0RnJhbWU6IDAsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gTmV4dCBmcmFtZVxuICAgICAgICAgICAgY2FsbGJhY2tEZXRhaWxzLmNhbGxiYWNrKHtcbiAgICAgICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgICAgICB0aW1lU2luY2VQcmV2aW91c0ZyYW1lOiBkZWx0YSxcbiAgICAgICAgICAgICAgdGltZVNpbmNlRmlyc3RGcmFtZTogdGltZXN0YW1wIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5hY3RpdmVGcmFtZUNhbGxiYWNrcy5zaXplID4gMCkge1xuICAgICAgICAgIHRoaXMucHJldmlvdXNGcmFtZVRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wcmV2aW91c0ZyYW1lVGltZXN0YW1wID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgLy8gcnVuQ2FsbGJhY2soKSBzaG91bGQgb25seSBiZSBjYWxsZWQgYWZ0ZXIgcmVnaXN0ZXJpbmcgYSBjYWxsYmFjayxcbiAgICAgIC8vIHNvIGlmIHRoZXJlIGlzIG9ubHkgb25lIGFjdGl2ZSBjYWxsYmFjaywgdGhlbiBpdCBtZWFucyB0aGF0IHRoZXJlIHdlcmVcbiAgICAgIC8vIHplcm8gcHJldmlvdXNseSBhbmQgdGhlIGxvb3AgaXNuJ3QgcnVubmluZyB5ZXQuXG4gICAgICBpZiAodGhpcy5hY3RpdmVGcmFtZUNhbGxiYWNrcy5zaXplID09PSAxICYmIGNhbGxJZCA9PT0gdGhpcy5uZXh0Q2FsbElkKSB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgcmVnaXN0ZXJGcmFtZUNhbGxiYWNrKFxuICAgICAgY2FsbGJhY2s6IChmcmFtZUluZm86IEZyYW1lSW5mbykgPT4gdm9pZCxcbiAgICAgIGNhbGxiYWNrSWQ6IG51bWJlclxuICAgICkge1xuICAgICAgdGhpcy5mcmFtZUNhbGxiYWNrUmVnaXN0cnkuc2V0KGNhbGxiYWNrSWQsIHtcbiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLFxuICAgICAgICBzdGFydFRpbWU6IG51bGwsXG4gICAgICB9KTtcbiAgICB9LFxuXG4gICAgdW5yZWdpc3RlckZyYW1lQ2FsbGJhY2soY2FsbGJhY2tJZDogbnVtYmVyKSB7XG4gICAgICB0aGlzLm1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjayhjYWxsYmFja0lkLCBmYWxzZSk7XG4gICAgICB0aGlzLmZyYW1lQ2FsbGJhY2tSZWdpc3RyeS5kZWxldGUoY2FsbGJhY2tJZCk7XG4gICAgfSxcblxuICAgIG1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjayhjYWxsYmFja0lkOiBudW1iZXIsIHN0YXRlOiBib29sZWFuKSB7XG4gICAgICBpZiAoY2FsbGJhY2tJZCA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3MuYWRkKGNhbGxiYWNrSWQpO1xuICAgICAgICB0aGlzLnJ1bkNhbGxiYWNrcyh0aGlzLm5leHRDYWxsSWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSB0aGlzLmZyYW1lQ2FsbGJhY2tSZWdpc3RyeS5nZXQoY2FsbGJhY2tJZCkhO1xuICAgICAgICBjYWxsYmFjay5zdGFydFRpbWUgPSBudWxsO1xuXG4gICAgICAgIHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrSWQpO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVGcmFtZUNhbGxiYWNrcy5zaXplID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5uZXh0Q2FsbElkICs9IDE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICB9O1xuXG4gIGdsb2JhbC5fZnJhbWVDYWxsYmFja1JlZ2lzdHJ5ID0gZnJhbWVDYWxsYmFja1JlZ2lzdHJ5O1xufSk7XG4iXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFBQSxRQUFBLEdBQUFDLE9BQUE7QUEyQk8sSUFBTUMsaUJBQWlCLEdBQUcsSUFBQUMsMkJBQWtCLEVBQUMsWUFBTTtFQUN4RCxTQUFTOztFQUVULElBQU1DLHFCQUE4QyxHQUFH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