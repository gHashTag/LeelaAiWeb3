e55b07054981398d3c5e42e25250c003
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ProgressTransitionManager = void 0;
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _threads = require("../../threads");
var _core = require("../../core");
var _reactNative = require("react-native");
function _defineProperty(obj, key, value) {
  key = _toPropertyKey(key);
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }
  return obj;
}
function _toPropertyKey(arg) {
  var key = _toPrimitive(arg, "string");
  return typeof key === "symbol" ? key : String(key);
}
function _toPrimitive(input, hint) {
  if (typeof input !== "object" || input === null) return input;
  var prim = input[Symbol.toPrimitive];
  if (prim !== undefined) {
    var res = prim.call(input, hint || "default");
    if (typeof res !== "object") return res;
    throw new TypeError("@@toPrimitive must return a primitive value.");
  }
  return (hint === "string" ? String : Number)(input);
}
var ProgressTransitionManager = function () {
  function ProgressTransitionManager() {
    (0, _classCallCheck2.default)(this, ProgressTransitionManager);
    _defineProperty(this, "_sharedElementCount", 0);
    _defineProperty(this, "_eventHandler", {
      isRegistered: false,
      onTransitionProgress: -1,
      onAppear: -1,
      onDisappear: -1,
      onSwipeDismiss: -1
    });
  }
  (0, _createClass2.default)(ProgressTransitionManager, [{
    key: "addProgressAnimation",
    value: function addProgressAnimation(viewTag, progressAnimation) {
      (0, _threads.runOnUIImmediately)(function () {
        'worklet';

        global.ProgressTransitionRegister.addProgressAnimation(viewTag, progressAnimation);
      })();
      this.registerEventHandlers();
    }
  }, {
    key: "removeProgressAnimation",
    value: function removeProgressAnimation(viewTag) {
      this.unregisterEventHandlers();
      (0, _threads.runOnUIImmediately)(function () {
        'worklet';

        global.ProgressTransitionRegister.removeProgressAnimation(viewTag);
      })();
    }
  }, {
    key: "registerEventHandlers",
    value: function registerEventHandlers() {
      this._sharedElementCount++;
      var eventHandler = this._eventHandler;
      if (!eventHandler.isRegistered) {
        eventHandler.isRegistered = true;
        var eventPrefix = _reactNative.Platform.OS === 'android' ? 'on' : 'top';
        var lastProgressValue = -1;
        eventHandler.onTransitionProgress = (0, _core.registerEventHandler)(eventPrefix + 'TransitionProgress', function (event) {
          'worklet';

          var progress = event.progress;
          if (progress === lastProgressValue) {
            return;
          }
          lastProgressValue = progress;
          global.ProgressTransitionRegister.frame(progress);
        });
        eventHandler.onAppear = (0, _core.registerEventHandler)(eventPrefix + 'Appear', function () {
          'worklet';

          global.ProgressTransitionRegister.onTransitionEnd();
        });
        if (_reactNative.Platform.OS === 'android') {
          eventHandler.onDisappear = (0, _core.registerEventHandler)('onFinishTransitioning', function () {
            'worklet';

            global.ProgressTransitionRegister.onAndroidFinishTransitioning();
          });
        } else if (_reactNative.Platform.OS === 'ios') {
          eventHandler.onDisappear = (0, _core.registerEventHandler)('topDisappear', function () {
            'worklet';

            global.ProgressTransitionRegister.onTransitionEnd(true);
          });
          eventHandler.onSwipeDismiss = (0, _core.registerEventHandler)('topGestureCancel', function () {
            'worklet';

            global.ProgressTransitionRegister.onTransitionEnd();
          });
        }
      }
    }
  }, {
    key: "unregisterEventHandlers",
    value: function unregisterEventHandlers() {
      this._sharedElementCount--;
      if (this._sharedElementCount === 0) {
        var eventHandler = this._eventHandler;
        eventHandler.isRegistered = false;
        if (eventHandler.onTransitionProgress !== -1) {
          (0, _core.unregisterEventHandler)(eventHandler.onTransitionProgress);
          eventHandler.onTransitionProgress = -1;
        }
        if (eventHandler.onAppear !== -1) {
          (0, _core.unregisterEventHandler)(eventHandler.onAppear);
          eventHandler.onAppear = -1;
        }
        if (eventHandler.onDisappear !== -1) {
          (0, _core.unregisterEventHandler)(eventHandler.onDisappear);
          eventHandler.onDisappear = -1;
        }
        if (eventHandler.onSwipeDismiss !== -1) {
          (0, _core.unregisterEventHandler)(eventHandler.onSwipeDismiss);
          eventHandler.onSwipeDismiss = -1;
        }
      }
    }
  }]);
  return ProgressTransitionManager;
}();
exports.ProgressTransitionManager = ProgressTransitionManager;
function createProgressTransitionRegister() {
  'worklet';

  var progressAnimations = new Map();
  var snapshots = new Map();
  var currentTransitions = new Set();
  var toRemove = new Set();
  var progressTransitionManager = {
    addProgressAnimation: function addProgressAnimation(viewTag, progressAnimation) {
      progressAnimations.set(viewTag, progressAnimation);
    },
    removeProgressAnimation: function removeProgressAnimation(viewTag) {
      if (progressAnimations.size > 1) {
        toRemove.add(viewTag);
      } else {
        progressAnimations.delete(viewTag);
      }
    },
    onTransitionStart: function onTransitionStart(viewTag, snapshot) {
      snapshots.set(viewTag, snapshot);
      currentTransitions.add(viewTag);
      progressTransitionManager.frame(0);
    },
    frame: function frame(progress) {
      for (var viewTag of currentTransitions) {
        var progressAnimation = progressAnimations.get(viewTag);
        var snapshot = snapshots.get(viewTag);
        progressAnimation(viewTag, snapshot, progress);
      }
    },
    onAndroidFinishTransitioning: function onAndroidFinishTransitioning() {
      if (toRemove.size > 0) {
        progressTransitionManager.onTransitionEnd();
      }
    },
    onTransitionEnd: function onTransitionEnd() {
      var removeViews = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;
      for (var viewTag of currentTransitions) {
        _notifyAboutEnd(viewTag, removeViews);
      }
      currentTransitions.clear();
      snapshots.clear();
      if (toRemove.size > 0) {
        for (var _viewTag of toRemove) {
          progressAnimations.delete(_viewTag);
        }
        toRemove.clear();
      }
    }
  };
  return progressTransitionManager;
}
(0, _threads.runOnUIImmediately)(function () {
  'worklet';

  global.ProgressTransitionRegister = createProgressTransitionRegister();
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdGhyZWFkcyIsInJlcXVpcmUiLCJfY29yZSIsIl9yZWFjdE5hdGl2ZSIsIlByb2dyZXNzVHJhbnNpdGlvbk1hbmFnZXIiLCJfY2xhc3NDYWxsQ2hlY2syIiwiZGVmYXVsdCIsIl9kZWZpbmVQcm9wZXJ0eSIsImlzUmVnaXN0ZXJlZCIsIm9uVHJhbnNpdGlvblByb2dyZXNzIiwib25BcHBlYXIiLCJvbkRpc2FwcGVhciIsIm9uU3dpcGVEaXNtaXNzIiwiX2NyZWF0ZUNsYXNzMiIsImtleSIsInZhbHVlIiwiYWRkUHJvZ3Jlc3NBbmltYXRpb24iLCJ2aWV3VGFnIiwicHJvZ3Jlc3NBbmltYXRpb24iLCJydW5PblVJSW1tZWRpYXRlbHkiLCJnbG9iYWwiLCJQcm9ncmVzc1RyYW5zaXRpb25SZWdpc3RlciIsInJlZ2lzdGVyRXZlbnRIYW5kbGVycyIsInJlbW92ZVByb2dyZXNzQW5pbWF0aW9uIiwidW5yZWdpc3RlckV2ZW50SGFuZGxlcnMiLCJfc2hhcmVkRWxlbWVudENvdW50IiwiZXZlbnRIYW5kbGVyIiwiX2V2ZW50SGFuZGxlciIsImV2ZW50UHJlZml4IiwiUGxhdGZvcm0iLCJPUyIsImxhc3RQcm9ncmVzc1ZhbHVlIiwicmVnaXN0ZXJFdmVudEhhbmRsZXIiLCJldmVudCIsInByb2dyZXNzIiwiZnJhbWUiLCJvblRyYW5zaXRpb25FbmQiLCJvbkFuZHJvaWRGaW5pc2hUcmFuc2l0aW9uaW5nIiwidW5yZWdpc3RlckV2ZW50SGFuZGxlciIsImV4cG9ydHMiLCJjcmVhdGVQcm9ncmVzc1RyYW5zaXRpb25SZWdpc3RlciIsInByb2dyZXNzQW5pbWF0aW9ucyIsIk1hcCIsInNuYXBzaG90cyIsImN1cnJlbnRUcmFuc2l0aW9ucyIsIlNldCIsInRvUmVtb3ZlIiwicHJvZ3Jlc3NUcmFuc2l0aW9uTWFuYWdlciIsInNldCIsInNpemUiLCJhZGQiLCJkZWxldGUiLCJvblRyYW5zaXRpb25TdGFydCIsInNuYXBzaG90IiwiZ2V0IiwicmVtb3ZlVmlld3MiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJ1bmRlZmluZWQiLCJfbm90aWZ5QWJvdXRFbmQiLCJjbGVhciJdLCJzb3VyY2VzIjpbIlByb2dyZXNzVHJhbnNpdGlvbk1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcnVuT25VSUltbWVkaWF0ZWx5IH0gZnJvbSAnLi4vLi4vdGhyZWFkcyc7XG5pbXBvcnQgdHlwZSB7IFByb2dyZXNzQW5pbWF0aW9uIH0gZnJvbSAnLi4vYW5pbWF0aW9uQnVpbGRlci9jb21tb25UeXBlcyc7XG5pbXBvcnQgeyByZWdpc3RlckV2ZW50SGFuZGxlciwgdW5yZWdpc3RlckV2ZW50SGFuZGxlciB9IGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdyZWFjdC1uYXRpdmUnO1xuXG50eXBlIFRyYW5zaXRpb25Qcm9ncmVzc0V2ZW50ID0ge1xuICBjbG9zaW5nOiBudW1iZXI7XG4gIGdvaW5nRm9yd2FyZDogbnVtYmVyO1xuICBldmVudE5hbWU6IHN0cmluZztcbiAgcHJvZ3Jlc3M6IG51bWJlcjtcbiAgdGFyZ2V0OiBudW1iZXI7XG59O1xuXG5leHBvcnQgY2xhc3MgUHJvZ3Jlc3NUcmFuc2l0aW9uTWFuYWdlciB7XG4gIHByaXZhdGUgX3NoYXJlZEVsZW1lbnRDb3VudCA9IDA7XG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlciA9IHtcbiAgICBpc1JlZ2lzdGVyZWQ6IGZhbHNlLFxuICAgIG9uVHJhbnNpdGlvblByb2dyZXNzOiAtMSxcbiAgICBvbkFwcGVhcjogLTEsXG4gICAgb25EaXNhcHBlYXI6IC0xLFxuICAgIG9uU3dpcGVEaXNtaXNzOiAtMSxcbiAgfTtcblxuICBwdWJsaWMgYWRkUHJvZ3Jlc3NBbmltYXRpb24oXG4gICAgdmlld1RhZzogbnVtYmVyLFxuICAgIHByb2dyZXNzQW5pbWF0aW9uOiBQcm9ncmVzc0FuaW1hdGlvblxuICApIHtcbiAgICBydW5PblVJSW1tZWRpYXRlbHkoKCkgPT4ge1xuICAgICAgJ3dvcmtsZXQnO1xuICAgICAgZ2xvYmFsLlByb2dyZXNzVHJhbnNpdGlvblJlZ2lzdGVyLmFkZFByb2dyZXNzQW5pbWF0aW9uKFxuICAgICAgICB2aWV3VGFnLFxuICAgICAgICBwcm9ncmVzc0FuaW1hdGlvblxuICAgICAgKTtcbiAgICB9KSgpO1xuICAgIHRoaXMucmVnaXN0ZXJFdmVudEhhbmRsZXJzKCk7XG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlUHJvZ3Jlc3NBbmltYXRpb24odmlld1RhZzogbnVtYmVyKSB7XG4gICAgdGhpcy51bnJlZ2lzdGVyRXZlbnRIYW5kbGVycygpO1xuICAgIHJ1bk9uVUlJbW1lZGlhdGVseSgoKSA9PiB7XG4gICAgICAnd29ya2xldCc7XG4gICAgICBnbG9iYWwuUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXIucmVtb3ZlUHJvZ3Jlc3NBbmltYXRpb24odmlld1RhZyk7XG4gICAgfSkoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJFdmVudEhhbmRsZXJzKCkge1xuICAgIHRoaXMuX3NoYXJlZEVsZW1lbnRDb3VudCsrO1xuICAgIGNvbnN0IGV2ZW50SGFuZGxlciA9IHRoaXMuX2V2ZW50SGFuZGxlcjtcbiAgICBpZiAoIWV2ZW50SGFuZGxlci5pc1JlZ2lzdGVyZWQpIHtcbiAgICAgIGV2ZW50SGFuZGxlci5pc1JlZ2lzdGVyZWQgPSB0cnVlO1xuICAgICAgY29uc3QgZXZlbnRQcmVmaXggPSBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnID8gJ29uJyA6ICd0b3AnO1xuICAgICAgbGV0IGxhc3RQcm9ncmVzc1ZhbHVlID0gLTE7XG4gICAgICBldmVudEhhbmRsZXIub25UcmFuc2l0aW9uUHJvZ3Jlc3MgPSByZWdpc3RlckV2ZW50SGFuZGxlcihcbiAgICAgICAgZXZlbnRQcmVmaXggKyAnVHJhbnNpdGlvblByb2dyZXNzJyxcbiAgICAgICAgKGV2ZW50OiBUcmFuc2l0aW9uUHJvZ3Jlc3NFdmVudCkgPT4ge1xuICAgICAgICAgICd3b3JrbGV0JztcbiAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IGV2ZW50LnByb2dyZXNzO1xuICAgICAgICAgIGlmIChwcm9ncmVzcyA9PT0gbGFzdFByb2dyZXNzVmFsdWUpIHtcbiAgICAgICAgICAgIC8vIER1cmluZyBzY3JlZW4gdHJhbnNpdGlvbiwgaGFuZGxlciByZWNlaXZlcyB0d28gZXZlbnRzIHdpdGggdGhlIHNhbWUgcHJvZ3Jlc3NcbiAgICAgICAgICAgIC8vIHZhbHVlIGZvciBib3RoIHNjcmVlbnMsIGJ1dCBmb3IgbW9kYWxzLCB0aGVyZSBpcyBvbmx5IG9uZSBldmVudC4gVG8gb3B0aW1pemVcbiAgICAgICAgICAgIC8vIHBlcmZvcm1hbmNlIGFuZCBhdm9pZCB1bm5lY2Vzc2FyeSB3b3JrbGV0IGNhbGxzLCBsZXQncyBza2lwIHRoZSBzZWNvbmQgZXZlbnQuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGxhc3RQcm9ncmVzc1ZhbHVlID0gcHJvZ3Jlc3M7XG4gICAgICAgICAgZ2xvYmFsLlByb2dyZXNzVHJhbnNpdGlvblJlZ2lzdGVyLmZyYW1lKHByb2dyZXNzKTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIGV2ZW50SGFuZGxlci5vbkFwcGVhciA9IHJlZ2lzdGVyRXZlbnRIYW5kbGVyKFxuICAgICAgICBldmVudFByZWZpeCArICdBcHBlYXInLFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgJ3dvcmtsZXQnO1xuICAgICAgICAgIGdsb2JhbC5Qcm9ncmVzc1RyYW5zaXRpb25SZWdpc3Rlci5vblRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgLy8gb25GaW5pc2hUcmFuc2l0aW9uaW5nIGV2ZW50IGlzIGF2YWlsYWJsZSBvbmx5IG9uIEFuZHJvaWQgYW5kXG4gICAgICAgIC8vIGlzIHVzZWQgdG8gaGFuZGxlIGNsb3NpbmcgbW9kYWxzXG4gICAgICAgIGV2ZW50SGFuZGxlci5vbkRpc2FwcGVhciA9IHJlZ2lzdGVyRXZlbnRIYW5kbGVyKFxuICAgICAgICAgICdvbkZpbmlzaFRyYW5zaXRpb25pbmcnLFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICd3b3JrbGV0JztcbiAgICAgICAgICAgIGdsb2JhbC5Qcm9ncmVzc1RyYW5zaXRpb25SZWdpc3Rlci5vbkFuZHJvaWRGaW5pc2hUcmFuc2l0aW9uaW5nKCk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHtcbiAgICAgICAgLy8gdG9wRGlzYXBwZWFyIGV2ZW50IGlzIHJlcXVpcmVkIHRvIGhhbmRsZSBjbG9zaW5nIG1vZGFscyBvbiBpT1NcbiAgICAgICAgZXZlbnRIYW5kbGVyLm9uRGlzYXBwZWFyID0gcmVnaXN0ZXJFdmVudEhhbmRsZXIoJ3RvcERpc2FwcGVhcicsICgpID0+IHtcbiAgICAgICAgICAnd29ya2xldCc7XG4gICAgICAgICAgZ2xvYmFsLlByb2dyZXNzVHJhbnNpdGlvblJlZ2lzdGVyLm9uVHJhbnNpdGlvbkVuZCh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGV2ZW50SGFuZGxlci5vblN3aXBlRGlzbWlzcyA9IHJlZ2lzdGVyRXZlbnRIYW5kbGVyKFxuICAgICAgICAgICd0b3BHZXN0dXJlQ2FuY2VsJyxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAnd29ya2xldCc7XG4gICAgICAgICAgICBnbG9iYWwuUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXIub25UcmFuc2l0aW9uRW5kKCk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdW5yZWdpc3RlckV2ZW50SGFuZGxlcnMoKTogdm9pZCB7XG4gICAgdGhpcy5fc2hhcmVkRWxlbWVudENvdW50LS07XG4gICAgaWYgKHRoaXMuX3NoYXJlZEVsZW1lbnRDb3VudCA9PT0gMCkge1xuICAgICAgY29uc3QgZXZlbnRIYW5kbGVyID0gdGhpcy5fZXZlbnRIYW5kbGVyO1xuICAgICAgZXZlbnRIYW5kbGVyLmlzUmVnaXN0ZXJlZCA9IGZhbHNlO1xuICAgICAgaWYgKGV2ZW50SGFuZGxlci5vblRyYW5zaXRpb25Qcm9ncmVzcyAhPT0gLTEpIHtcbiAgICAgICAgdW5yZWdpc3RlckV2ZW50SGFuZGxlcihldmVudEhhbmRsZXIub25UcmFuc2l0aW9uUHJvZ3Jlc3MpO1xuICAgICAgICBldmVudEhhbmRsZXIub25UcmFuc2l0aW9uUHJvZ3Jlc3MgPSAtMTtcbiAgICAgIH1cbiAgICAgIGlmIChldmVudEhhbmRsZXIub25BcHBlYXIgIT09IC0xKSB7XG4gICAgICAgIHVucmVnaXN0ZXJFdmVudEhhbmRsZXIoZXZlbnRIYW5kbGVyLm9uQXBwZWFyKTtcbiAgICAgICAgZXZlbnRIYW5kbGVyLm9uQXBwZWFyID0gLTE7XG4gICAgICB9XG4gICAgICBpZiAoZXZlbnRIYW5kbGVyLm9uRGlzYXBwZWFyICE9PSAtMSkge1xuICAgICAgICB1bnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGV2ZW50SGFuZGxlci5vbkRpc2FwcGVhcik7XG4gICAgICAgIGV2ZW50SGFuZGxlci5vbkRpc2FwcGVhciA9IC0xO1xuICAgICAgfVxuICAgICAgaWYgKGV2ZW50SGFuZGxlci5vblN3aXBlRGlzbWlzcyAhPT0gLTEpIHtcbiAgICAgICAgdW5yZWdpc3RlckV2ZW50SGFuZGxlcihldmVudEhhbmRsZXIub25Td2lwZURpc21pc3MpO1xuICAgICAgICBldmVudEhhbmRsZXIub25Td2lwZURpc21pc3MgPSAtMTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXIoKSB7XG4gICd3b3JrbGV0JztcbiAgY29uc3QgcHJvZ3Jlc3NBbmltYXRpb25zID0gbmV3IE1hcDxudW1iZXIsIFByb2dyZXNzQW5pbWF0aW9uPigpO1xuICBjb25zdCBzbmFwc2hvdHMgPSBuZXcgTWFwPG51bWJlciwgYW55PigpO1xuICBjb25zdCBjdXJyZW50VHJhbnNpdGlvbnMgPSBuZXcgU2V0PG51bWJlcj4oKTtcbiAgY29uc3QgdG9SZW1vdmUgPSBuZXcgU2V0PG51bWJlcj4oKTtcblxuICBjb25zdCBwcm9ncmVzc1RyYW5zaXRpb25NYW5hZ2VyID0ge1xuICAgIGFkZFByb2dyZXNzQW5pbWF0aW9uOiAoXG4gICAgICB2aWV3VGFnOiBudW1iZXIsXG4gICAgICBwcm9ncmVzc0FuaW1hdGlvbjogUHJvZ3Jlc3NBbmltYXRpb25cbiAgICApID0+IHtcbiAgICAgIHByb2dyZXNzQW5pbWF0aW9ucy5zZXQodmlld1RhZywgcHJvZ3Jlc3NBbmltYXRpb24pO1xuICAgIH0sXG4gICAgcmVtb3ZlUHJvZ3Jlc3NBbmltYXRpb246ICh2aWV3VGFnOiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChwcm9ncmVzc0FuaW1hdGlvbnMuc2l6ZSA+IDEpIHtcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBhbmltYXRpb24gY29uZmlnIGFmdGVyIHRoZSB0cmFuc2l0aW9uIGlzIGZpbmlzaGVkXG4gICAgICAgIHRvUmVtb3ZlLmFkZCh2aWV3VGFnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb2dyZXNzQW5pbWF0aW9ucy5kZWxldGUodmlld1RhZyk7XG4gICAgICB9XG4gICAgfSxcbiAgICBvblRyYW5zaXRpb25TdGFydDogKHZpZXdUYWc6IG51bWJlciwgc25hcHNob3Q6IGFueSkgPT4ge1xuICAgICAgc25hcHNob3RzLnNldCh2aWV3VGFnLCBzbmFwc2hvdCk7XG4gICAgICBjdXJyZW50VHJhbnNpdGlvbnMuYWRkKHZpZXdUYWcpO1xuICAgICAgLy8gc2V0IGluaXRpYWwgc3R5bGUgZm9yIHJlLXBhcmVudGVkIGNvbXBvbmVudHNcbiAgICAgIHByb2dyZXNzVHJhbnNpdGlvbk1hbmFnZXIuZnJhbWUoMCk7XG4gICAgfSxcbiAgICBmcmFtZTogKHByb2dyZXNzOiBudW1iZXIpID0+IHtcbiAgICAgIGZvciAoY29uc3Qgdmlld1RhZyBvZiBjdXJyZW50VHJhbnNpdGlvbnMpIHtcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3NBbmltYXRpb24gPSBwcm9ncmVzc0FuaW1hdGlvbnMuZ2V0KHZpZXdUYWcpO1xuICAgICAgICBjb25zdCBzbmFwc2hvdCA9IHNuYXBzaG90cy5nZXQodmlld1RhZyk7XG4gICAgICAgIHByb2dyZXNzQW5pbWF0aW9uISh2aWV3VGFnLCBzbmFwc2hvdCwgcHJvZ3Jlc3MpO1xuICAgICAgfVxuICAgIH0sXG4gICAgb25BbmRyb2lkRmluaXNoVHJhbnNpdGlvbmluZzogKCkgPT4ge1xuICAgICAgaWYgKHRvUmVtb3ZlLnNpemUgPiAwKSB7XG4gICAgICAgIC8vIGl0IHNob3VsZCBiZSByYW4gb25seSBvbiBtb2RhbCBjbG9zaW5nXG4gICAgICAgIHByb2dyZXNzVHJhbnNpdGlvbk1hbmFnZXIub25UcmFuc2l0aW9uRW5kKCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBvblRyYW5zaXRpb25FbmQ6IChyZW1vdmVWaWV3cyA9IGZhbHNlKSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IHZpZXdUYWcgb2YgY3VycmVudFRyYW5zaXRpb25zKSB7XG4gICAgICAgIF9ub3RpZnlBYm91dEVuZCh2aWV3VGFnLCByZW1vdmVWaWV3cyk7XG4gICAgICB9XG4gICAgICBjdXJyZW50VHJhbnNpdGlvbnMuY2xlYXIoKTtcbiAgICAgIHNuYXBzaG90cy5jbGVhcigpO1xuICAgICAgaWYgKHRvUmVtb3ZlLnNpemUgPiAwKSB7XG4gICAgICAgIGZvciAoY29uc3Qgdmlld1RhZyBvZiB0b1JlbW92ZSkge1xuICAgICAgICAgIHByb2dyZXNzQW5pbWF0aW9ucy5kZWxldGUodmlld1RhZyk7XG4gICAgICAgIH1cbiAgICAgICAgdG9SZW1vdmUuY2xlYXIoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xuICByZXR1cm4gcHJvZ3Jlc3NUcmFuc2l0aW9uTWFuYWdlcjtcbn1cblxucnVuT25VSUltbWVkaWF0ZWx5KCgpID0+IHtcbiAgJ3dvcmtsZXQnO1xuICBnbG9iYWwuUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXIgPSBjcmVhdGVQcm9ncmVzc1RyYW5zaXRpb25SZWdpc3RlcigpO1xufSkoKTtcblxuZXhwb3J0IHR5cGUgUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXIgPSBSZXR1cm5UeXBlPFxuICB0eXBlb2YgY3JlYXRlUHJvZ3Jlc3NUcmFuc2l0aW9uUmVnaXN0ZXJcbj47XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFBQSxRQUFBLEdBQUFDLE9BQUE7QUFFQSxJQUFBQyxLQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxZQUFBLEdBQUFGLE9BQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBVWFHLHlCQUF5QjtFQUFDLFNBQUFBLDBCQUFBO0lBQUEsSUFBQUMsZ0JBQUEsQ0FBQUMsT0FBQSxRQUFBRix5QkFBQTtJQUFBRyxlQUFBLDhCQUNQLENBQUM7SUFBQUEsZUFBQSx3QkFDUDtNQUN0QkMsWUFBWSxFQUFFLEtBQUs7TUFDbkJDLG9CQUFvQixFQUFFLENBQUMsQ0FBQztNQUN4QkMsUUFBUSxFQUFFLENBQUMsQ0FBQztNQUNaQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO01BQ2ZDLGNBQWMsRUFBRSxDQUFDO0lBQ25CLENBQUM7RUFBQTtFQUFBLElBQUFDLGFBQUEsQ0FBQVAsT0FBQSxFQUFBRix5QkFBQTtJQUFBVSxHQUFBO0lBQUFDLEtBQUEsRUFFTSxTQUFBQyxxQkFDTEMsT0FBZSxFQUNmQyxpQkFBb0MsRUFDcEM7TUFDQSxJQUFBQywyQkFBa0IsRUFBQyxZQUFNO1FBQ3ZCLFNBQVM7O1FBQ1RDLE1BQU0sQ0FBQ0MsMEJBQTBCLENBQUNMLG9CQUFvQixDQUNwREMsT0FBTyxFQUNQQyxpQkFBaUIsQ0FDbEI7TUFDSCxDQUFDLENBQUMsRUFBRTtNQUNKLElBQUksQ0FBQ0kscUJBQXFCLEVBQUU7SUFDOUI7RUFBQTtJQUFBUixHQUFBO0lBQUFDLEtBQUEsRUFFTyxTQUFBUSx3QkFBd0JOLE9BQWUs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