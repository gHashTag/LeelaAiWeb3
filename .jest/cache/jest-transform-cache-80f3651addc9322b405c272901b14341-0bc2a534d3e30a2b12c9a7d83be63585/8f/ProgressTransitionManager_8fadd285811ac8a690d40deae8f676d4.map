{"version":3,"names":["_threads","require","_core","_reactNative","ProgressTransitionManager","_classCallCheck2","default","_defineProperty","isRegistered","onTransitionProgress","onAppear","onDisappear","onSwipeDismiss","_createClass2","key","value","addProgressAnimation","viewTag","progressAnimation","runOnUIImmediately","global","ProgressTransitionRegister","registerEventHandlers","removeProgressAnimation","unregisterEventHandlers","_sharedElementCount","eventHandler","_eventHandler","eventPrefix","Platform","OS","lastProgressValue","registerEventHandler","event","progress","frame","onTransitionEnd","onAndroidFinishTransitioning","unregisterEventHandler","exports","createProgressTransitionRegister","progressAnimations","Map","snapshots","currentTransitions","Set","toRemove","progressTransitionManager","set","size","add","delete","onTransitionStart","snapshot","get","removeViews","arguments","length","undefined","_notifyAboutEnd","clear"],"sources":["ProgressTransitionManager.ts"],"sourcesContent":["import { runOnUIImmediately } from '../../threads';\nimport type { ProgressAnimation } from '../animationBuilder/commonTypes';\nimport { registerEventHandler, unregisterEventHandler } from '../../core';\nimport { Platform } from 'react-native';\n\ntype TransitionProgressEvent = {\n  closing: number;\n  goingForward: number;\n  eventName: string;\n  progress: number;\n  target: number;\n};\n\nexport class ProgressTransitionManager {\n  private _sharedElementCount = 0;\n  private _eventHandler = {\n    isRegistered: false,\n    onTransitionProgress: -1,\n    onAppear: -1,\n    onDisappear: -1,\n    onSwipeDismiss: -1,\n  };\n\n  public addProgressAnimation(\n    viewTag: number,\n    progressAnimation: ProgressAnimation\n  ) {\n    runOnUIImmediately(() => {\n      'worklet';\n      global.ProgressTransitionRegister.addProgressAnimation(\n        viewTag,\n        progressAnimation\n      );\n    })();\n    this.registerEventHandlers();\n  }\n\n  public removeProgressAnimation(viewTag: number) {\n    this.unregisterEventHandlers();\n    runOnUIImmediately(() => {\n      'worklet';\n      global.ProgressTransitionRegister.removeProgressAnimation(viewTag);\n    })();\n  }\n\n  private registerEventHandlers() {\n    this._sharedElementCount++;\n    const eventHandler = this._eventHandler;\n    if (!eventHandler.isRegistered) {\n      eventHandler.isRegistered = true;\n      const eventPrefix = Platform.OS === 'android' ? 'on' : 'top';\n      let lastProgressValue = -1;\n      eventHandler.onTransitionProgress = registerEventHandler(\n        eventPrefix + 'TransitionProgress',\n        (event: TransitionProgressEvent) => {\n          'worklet';\n          const progress = event.progress;\n          if (progress === lastProgressValue) {\n            // During screen transition, handler receives two events with the same progress\n            // value for both screens, but for modals, there is only one event. To optimize\n            // performance and avoid unnecessary worklet calls, let's skip the second event.\n            return;\n          }\n          lastProgressValue = progress;\n          global.ProgressTransitionRegister.frame(progress);\n        }\n      );\n      eventHandler.onAppear = registerEventHandler(\n        eventPrefix + 'Appear',\n        () => {\n          'worklet';\n          global.ProgressTransitionRegister.onTransitionEnd();\n        }\n      );\n\n      if (Platform.OS === 'android') {\n        // onFinishTransitioning event is available only on Android and\n        // is used to handle closing modals\n        eventHandler.onDisappear = registerEventHandler(\n          'onFinishTransitioning',\n          () => {\n            'worklet';\n            global.ProgressTransitionRegister.onAndroidFinishTransitioning();\n          }\n        );\n      } else if (Platform.OS === 'ios') {\n        // topDisappear event is required to handle closing modals on iOS\n        eventHandler.onDisappear = registerEventHandler('topDisappear', () => {\n          'worklet';\n          global.ProgressTransitionRegister.onTransitionEnd(true);\n        });\n        eventHandler.onSwipeDismiss = registerEventHandler(\n          'topGestureCancel',\n          () => {\n            'worklet';\n            global.ProgressTransitionRegister.onTransitionEnd();\n          }\n        );\n      }\n    }\n  }\n\n  private unregisterEventHandlers(): void {\n    this._sharedElementCount--;\n    if (this._sharedElementCount === 0) {\n      const eventHandler = this._eventHandler;\n      eventHandler.isRegistered = false;\n      if (eventHandler.onTransitionProgress !== -1) {\n        unregisterEventHandler(eventHandler.onTransitionProgress);\n        eventHandler.onTransitionProgress = -1;\n      }\n      if (eventHandler.onAppear !== -1) {\n        unregisterEventHandler(eventHandler.onAppear);\n        eventHandler.onAppear = -1;\n      }\n      if (eventHandler.onDisappear !== -1) {\n        unregisterEventHandler(eventHandler.onDisappear);\n        eventHandler.onDisappear = -1;\n      }\n      if (eventHandler.onSwipeDismiss !== -1) {\n        unregisterEventHandler(eventHandler.onSwipeDismiss);\n        eventHandler.onSwipeDismiss = -1;\n      }\n    }\n  }\n}\n\nfunction createProgressTransitionRegister() {\n  'worklet';\n  const progressAnimations = new Map<number, ProgressAnimation>();\n  const snapshots = new Map<number, any>();\n  const currentTransitions = new Set<number>();\n  const toRemove = new Set<number>();\n\n  const progressTransitionManager = {\n    addProgressAnimation: (\n      viewTag: number,\n      progressAnimation: ProgressAnimation\n    ) => {\n      progressAnimations.set(viewTag, progressAnimation);\n    },\n    removeProgressAnimation: (viewTag: number) => {\n      if (progressAnimations.size > 1) {\n        // Remove the animation config after the transition is finished\n        toRemove.add(viewTag);\n      } else {\n        progressAnimations.delete(viewTag);\n      }\n    },\n    onTransitionStart: (viewTag: number, snapshot: any) => {\n      snapshots.set(viewTag, snapshot);\n      currentTransitions.add(viewTag);\n      // set initial style for re-parented components\n      progressTransitionManager.frame(0);\n    },\n    frame: (progress: number) => {\n      for (const viewTag of currentTransitions) {\n        const progressAnimation = progressAnimations.get(viewTag);\n        const snapshot = snapshots.get(viewTag);\n        progressAnimation!(viewTag, snapshot, progress);\n      }\n    },\n    onAndroidFinishTransitioning: () => {\n      if (toRemove.size > 0) {\n        // it should be ran only on modal closing\n        progressTransitionManager.onTransitionEnd();\n      }\n    },\n    onTransitionEnd: (removeViews = false) => {\n      for (const viewTag of currentTransitions) {\n        _notifyAboutEnd(viewTag, removeViews);\n      }\n      currentTransitions.clear();\n      snapshots.clear();\n      if (toRemove.size > 0) {\n        for (const viewTag of toRemove) {\n          progressAnimations.delete(viewTag);\n        }\n        toRemove.clear();\n      }\n    },\n  };\n  return progressTransitionManager;\n}\n\nrunOnUIImmediately(() => {\n  'worklet';\n  global.ProgressTransitionRegister = createProgressTransitionRegister();\n})();\n\nexport type ProgressTransitionRegister = ReturnType<\n  typeof createProgressTransitionRegister\n>;\n"],"mappings":"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"}